<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JavaUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rubyspec coverage</a> &gt; <a href="index.source.html" class="el_package">org.jruby.javasupport</a> &gt; <span class="el_source">JavaUtil.java</span></div><h1>JavaUtil.java</h1><pre class="source lang-java linenums">/***** BEGIN LICENSE BLOCK *****
 * Version: EPL 1.0/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Eclipse Public
 * License Version 1.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of
 * the License at http://www.eclipse.org/legal/epl-v10.html
 *
 * Software distributed under the License is distributed on an &quot;AS
 * IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or
 * implied. See the License for the specific language governing
 * rights and limitations under the License.
 *
 * Copyright (C) 2001 Alan Moore &lt;alan_moore@gmx.net&gt;
 * Copyright (C) 2001-2004 Jan Arne Petersen &lt;jpetersen@uni-bonn.de&gt;
 * Copyright (C) 2002 Anders Bengtsson &lt;ndrsbngtssn@yahoo.se&gt;
 * Copyright (C) 2002 Benoit Cerrina &lt;b.cerrina@wanadoo.fr&gt;
 * Copyright (C) 2002 Don Schwartz &lt;schwardo@users.sourceforge.net&gt;
 * Copyright (C) 2004 Stefan Matthias Aust &lt;sma@3plus4.de&gt;
 * Copyright (C) 2006 Kresten Krab Thorup &lt;krab@gnu.org&gt;
 * 
 * Alternatively, the contents of this file may be used under the terms of
 * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),
 * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the EPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the EPL, the GPL or the LGPL.
 ***** END LICENSE BLOCK *****/
package org.jruby.javasupport;

import java.io.Serializable;
import java.io.UnsupportedEncodingException;
import java.lang.reflect.Array;
import java.lang.reflect.Method;
import static java.lang.Character.isLetter;
import static java.lang.Character.isLowerCase;
import static java.lang.Character.isUpperCase;
import static java.lang.Character.isDigit;
import static java.lang.Character.toLowerCase;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.util.HashMap;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;

import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.jruby.Ruby;
import org.jruby.RubyArray;
import org.jruby.RubyBasicObject;
import org.jruby.ext.bigdecimal.RubyBigDecimal;
import org.jruby.RubyBignum;
import org.jruby.RubyBoolean;
import org.jruby.RubyClass;
import org.jruby.RubyEncoding;
import org.jruby.RubyFixnum;
import org.jruby.RubyFloat;
import org.jruby.RubyModule;
import org.jruby.RubyNil;
import org.jruby.RubyNumeric;
import org.jruby.RubyObject;
import org.jruby.RubyProc;
import org.jruby.RubyString;
import org.jruby.RubyTime;
import org.jruby.internal.runtime.methods.CallConfiguration;
import org.jruby.internal.runtime.methods.DynamicMethod;
import org.jruby.java.proxies.ArrayJavaProxy;
import org.jruby.java.proxies.JavaProxy;
import org.jruby.java.proxies.RubyObjectHolderProxy;
import org.jruby.javasupport.proxy.InternalJavaProxy;
import org.jruby.runtime.Helpers;
import org.jruby.runtime.Block;
import org.jruby.runtime.ClassIndex;
import org.jruby.runtime.ThreadContext;
import org.jruby.runtime.Visibility;
import org.jruby.runtime.builtin.IRubyObject;

import org.jruby.util.ByteList;
import org.jruby.util.CodegenUtils;
import org.jruby.util.TypeConverter;

<span class="nc" id="L89">public class JavaUtil {</span>
    public static IRubyObject[] convertJavaArrayToRuby(Ruby runtime, Object[] objects) {
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (objects == null) return IRubyObject.NULL_ARRAY;</span>
        
<span class="fc" id="L93">        IRubyObject[] rubyObjects = new IRubyObject[objects.length];</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        for (int i = 0; i &lt; objects.length; i++) {</span>
<span class="fc" id="L95">            rubyObjects[i] = convertJavaToUsableRubyObject(runtime, objects[i]);</span>
        }
<span class="fc" id="L97">        return rubyObjects;</span>
    }

    public static RubyArray convertJavaArrayToRubyWithNesting(ThreadContext context, Object array) {
<span class="nc" id="L101">        int length = Array.getLength(array);</span>
<span class="nc" id="L102">        RubyArray outer = context.runtime.newArray(length);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        for (int i = 0; i &lt; length; i++) {</span>
<span class="nc" id="L104">            Object element = Array.get(array, i);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (element instanceof ArrayJavaProxy) {</span>
<span class="nc" id="L106">                outer.append(convertJavaArrayToRubyWithNesting(context, ((ArrayJavaProxy)element).getObject()));</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">            } else if (element != null &amp;&amp; element.getClass().isArray()) {</span>
<span class="nc" id="L108">                outer.append(convertJavaArrayToRubyWithNesting(context, element));</span>
            } else {
<span class="nc" id="L110">                outer.append(JavaUtil.convertJavaToUsableRubyObject(context.runtime, element));</span>
            }
        }
<span class="nc" id="L113">        return outer;</span>
    }

    public static JavaConverter getJavaConverter(Class clazz) {
<span class="fc" id="L117">        JavaConverter converter = JAVA_CONVERTERS.get(clazz);</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (converter == null) {</span>
<span class="fc" id="L120">            converter = JAVA_DEFAULT_CONVERTER;</span>
        }

<span class="fc" id="L123">        return converter;</span>
    }

    public static IRubyObject convertJavaToRuby(Ruby runtime, Object object) {
<span class="nc" id="L127">        return convertJavaToUsableRubyObject(runtime, object);</span>
    }

    public static IRubyObject convertJavaToRuby(Ruby runtime, Object object, Class javaClass) {
<span class="nc" id="L131">        return convertJavaToUsableRubyObjectWithConverter(runtime, object, getJavaConverter(javaClass));</span>
    }

    public static IRubyObject convertJavaToRuby(Ruby runtime, int i) {
<span class="nc" id="L135">        return runtime.newFixnum(i);</span>
    }

    public static IRubyObject convertJavaToRuby(Ruby runtime, long l) {
<span class="nc" id="L139">        return runtime.newFixnum(l);</span>
    }

    public static IRubyObject convertJavaToRuby(Ruby runtime, float f) {
<span class="nc" id="L143">        return runtime.newFloat(f);</span>
    }

    public static IRubyObject convertJavaToRuby(Ruby runtime, double d) {
<span class="nc" id="L147">        return runtime.newFloat(d);</span>
    }

    public static IRubyObject convertJavaToRuby(Ruby runtime, boolean b) {
<span class="nc" id="L151">        return runtime.newBoolean(b);</span>
    }

    /**
     * Returns a usable RubyObject; for types that are not converted to Ruby native
     * types, a Java proxy will be returned.
     *
     * @param runtime
     * @param object
     * @return corresponding Ruby type, or a functional Java proxy
     */
    public static IRubyObject convertJavaToUsableRubyObject(Ruby runtime, Object object) {
<span class="fc" id="L163">        IRubyObject result = trySimpleConversions(runtime, object);</span>

<span class="fc bfc" id="L165" title="All 2 branches covered.">        if (result != null) return result;</span>

<span class="fc" id="L167">        JavaConverter converter = getJavaConverter(object.getClass());</span>
<span class="pc bpc" id="L168" title="1 of 4 branches missed.">        if (converter == null || converter == JAVA_DEFAULT_CONVERTER) {</span>
<span class="fc" id="L169">            return Java.getInstance(runtime, object);</span>
        }
<span class="fc" id="L171">        return converter.convert(runtime, object);</span>
    }

    public static IRubyObject convertJavaToUsableRubyObjectWithConverter(Ruby runtime, Object object, JavaConverter converter) {
<span class="fc" id="L175">        IRubyObject result = trySimpleConversions(runtime, object);</span>

<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (result != null) return result;</span>

<span class="pc bpc" id="L179" title="1 of 4 branches missed.">        if (converter == null || converter == JAVA_DEFAULT_CONVERTER) {</span>
<span class="fc" id="L180">            return Java.getInstance(runtime, object);</span>
        }
<span class="fc" id="L182">        return converter.convert(runtime, object);</span>
    }

    public static IRubyObject convertJavaArrayElementToRuby(Ruby runtime, JavaConverter converter, Object array, int i) {
<span class="nc bnc" id="L186" title="All 4 branches missed.">        if (converter == null || converter == JAVA_DEFAULT_CONVERTER) {</span>
<span class="nc" id="L187">            IRubyObject x = convertJavaToUsableRubyObject(runtime, ((Object[])array)[i]);</span>
<span class="nc" id="L188">            return x;</span>
        }
<span class="nc" id="L190">        return converter.get(runtime, array, i);</span>
    }

    public static Class&lt;?&gt; primitiveToWrapper(Class&lt;?&gt; type) {
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (type.isPrimitive()) {</span>
<span class="nc" id="L195">            return CodegenUtils.getBoxType(type);</span>
        }
<span class="nc" id="L197">        return type;</span>
    }

    public static boolean isDuckTypeConvertable(Class providedArgumentType, Class parameterType) {
<span class="nc" id="L201">        return</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                parameterType.isInterface() &amp;&amp;</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                !parameterType.isAssignableFrom(providedArgumentType) &amp;&amp;</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                RubyObject.class.isAssignableFrom(providedArgumentType);</span>
    }

    public static Object convertProcToInterface(ThreadContext context, RubyObject rubyObject, Class target) {
<span class="nc" id="L208">        return convertProcToInterface(context, (RubyBasicObject)rubyObject, target);</span>
    }

    public static Object convertProcToInterface(ThreadContext context, RubyBasicObject rubyObject, Class target) {
<span class="nc" id="L212">        Ruby runtime = context.runtime;</span>
<span class="nc" id="L213">        RubyModule javaInterfaceModule = (RubyModule)Java.get_interface_module(runtime, JavaClass.get(runtime, target));</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!((RubyModule) javaInterfaceModule).isInstance(rubyObject)) {</span>
<span class="nc" id="L215">            javaInterfaceModule.callMethod(context, &quot;extend_object&quot;, rubyObject);</span>
<span class="nc" id="L216">            javaInterfaceModule.callMethod(context, &quot;extended&quot;, rubyObject);</span>
        }

<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (rubyObject instanceof RubyProc) {</span>
            // Proc implementing an interface, pull in the catch-all code that lets the proc get invoked
            // no matter what method is called on the interface
<span class="nc" id="L222">            RubyClass singletonClass = rubyObject.getSingletonClass();</span>

<span class="nc" id="L224">            singletonClass.addMethod(&quot;method_missing&quot;, new DynamicMethod(singletonClass, Visibility.PUBLIC, CallConfiguration.FrameNoneScopeNone) {</span>

                @Override
                public IRubyObject call(ThreadContext context, IRubyObject self, RubyModule clazz, String name, IRubyObject[] args, Block block) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">                    if (!(self instanceof RubyProc)) {</span>
<span class="nc" id="L229">                        throw context.runtime.newTypeError(&quot;interface impl method_missing for block used with non-Proc object&quot;);</span>
                    }
<span class="nc" id="L231">                    RubyProc proc = (RubyProc)self;</span>
                    IRubyObject[] newArgs;
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    if (args.length == 1) {</span>
<span class="nc" id="L234">                        newArgs = IRubyObject.NULL_ARRAY;</span>
                    } else {
<span class="nc" id="L236">                        newArgs = new IRubyObject[args.length - 1];</span>
<span class="nc" id="L237">                        System.arraycopy(args, 1, newArgs, 0, args.length - 1);</span>
                    }
<span class="nc" id="L239">                    return proc.call(context, newArgs);</span>
                }

                @Override
                public DynamicMethod dup() {
<span class="nc" id="L244">                    return this;</span>
                }
            });
        }
<span class="nc" id="L248">        JavaObject jo = (JavaObject) Helpers.invoke(context, rubyObject, &quot;__jcreate_meta!&quot;);</span>
<span class="nc" id="L249">        return jo.getValue();</span>
    }

    public static NumericConverter getNumericConverter(Class target) {
<span class="fc" id="L253">        NumericConverter converter = NUMERIC_CONVERTERS.get(target);</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">        if (converter == null) {</span>
<span class="nc" id="L255">            return NUMERIC_TO_OTHER;</span>
        }
<span class="fc" id="L257">        return converter;</span>
    }

    public static boolean isJavaObject(IRubyObject candidate) {
<span class="nc bnc" id="L261" title="All 4 branches missed.">        return candidate instanceof JavaProxy || candidate.dataGetStruct() instanceof JavaObject;</span>
    }

    public static Object unwrapJavaObject(IRubyObject object) {
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (object instanceof JavaProxy) {</span>
<span class="nc" id="L266">            return ((JavaProxy)object).getObject();</span>
        }
<span class="nc" id="L268">        return ((JavaObject)object.dataGetStruct()).getValue();</span>
    }

    public static Object unwrapJavaValue(Ruby runtime, IRubyObject obj, String errorMessage) {
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (obj instanceof JavaProxy) {</span>
<span class="nc" id="L273">            return ((JavaProxy)obj).getObject();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        } else if (obj instanceof JavaObject) {</span>
<span class="nc" id="L275">            return ((JavaObject)obj).getValue();</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">        } else if(obj.dataGetStruct() != null &amp;&amp; (obj.dataGetStruct() instanceof IRubyObject)) {</span>
<span class="nc" id="L277">            return unwrapJavaValue(runtime, ((IRubyObject)obj.dataGetStruct()), errorMessage);</span>
        } else {
<span class="nc" id="L279">            throw runtime.newTypeError(errorMessage);</span>
        }
    }

    /**
     * For methods that match /(get|set|is)([A-Z0-9])(.*)/, return the &quot;name&quot;
     * part of the property with leading lower-case.
     *
     * Does not use regex for performance reasons.
     *
     * @param beanMethodName the bean method from which to extract a name
     * @return the bean property name
     */
    public static String getJavaPropertyName(String beanMethodName) {
<span class="fc" id="L293">        int length = beanMethodName.length();</span>
        char ch;
<span class="fc bfc" id="L295" title="All 6 branches covered.">        if ((beanMethodName.startsWith(&quot;get&quot;) || beanMethodName.startsWith(&quot;set&quot;)) &amp;&amp; length &gt; 3) {</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">            if (isUpperDigit(ch = beanMethodName.charAt(3))) {</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">                if (length == 4) {</span>
<span class="nc" id="L298">                    return Character.toString(toLowerCase(ch));</span>
                } else {
<span class="fc" id="L300">                    return &quot;&quot; + toLowerCase(ch) + beanMethodName.substring(4);</span>
                }
            }
<span class="pc bpc" id="L303" title="1 of 4 branches missed.">        } else if (beanMethodName.startsWith(&quot;is&quot;) &amp;&amp; length &gt; 2) {</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">            if (isUpperDigit(ch = beanMethodName.charAt(2))) {</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">                if (length == 3) {</span>
<span class="nc" id="L306">                    return Character.toString(toLowerCase(ch));</span>
                } else {
<span class="fc" id="L308">                    return &quot;&quot; + toLowerCase(ch) + beanMethodName.substring(3);</span>
                }
            }
        }
<span class="fc" id="L312">        return null;</span>
    }

    /**
     * Build a Ruby name from a Java name by treating aA as _ divider and successive
     * caps as all the same word.
     */
    public static String getRubyCasedName(String javaCasedName) {
<span class="fc" id="L320">        StringBuilder b = new StringBuilder();</span>
<span class="fc" id="L321">        char[] chars = javaCasedName.toCharArray();</span>
<span class="fc" id="L322">        int behind = 0;</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">        for (int i = 0; i &lt; chars.length; i++) {</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">            if (behind &lt; 2) {</span>
<span class="fc" id="L325">                behind++;</span>
            } else {
<span class="fc" id="L327">                behind = consume(b, chars, i);</span>
            }
        }

<span class="fc bfc" id="L331" title="All 2 branches covered.">        if (behind == 2) {</span>
<span class="fc" id="L332">            b.append(toLowerCase(chars[chars.length - 2]));</span>
<span class="pc bpc" id="L333" title="1 of 4 branches missed.">            if (isUpperCase(chars[chars.length - 1]) &amp;&amp; !isUpperCase(chars[chars.length - 2])) b.append('_');</span>
<span class="fc" id="L334">            b.append(toLowerCase(chars[chars.length - 1]));</span>
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">        } else if (behind &gt; 0) {</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">            if (behind &gt; 1) {</span>
<span class="nc" id="L337">                b.append(toLowerCase(chars[chars.length - 2]));</span>
            }
<span class="fc" id="L339">            b.append(toLowerCase(chars[chars.length - 1]));</span>
        }
<span class="fc" id="L341">        return b.toString();</span>
    }
    
    private static int consume(StringBuilder b, char[] chars, int i) {
        char cur, prev, prev2;
<span class="fc bfc" id="L346" title="All 4 branches covered.">        if (isLowerDigit(prev2 = chars[i - 2]) &amp;&amp; isUpperCase(prev = chars[i - 1])) {</span>
<span class="fc" id="L347">            b.append(prev2).append('_').append(toLowerCase(prev));</span>
<span class="fc" id="L348">            return 1;</span>
<span class="fc bfc" id="L349" title="All 6 branches covered.">        } else if (isLetterDigit(prev2) &amp;&amp; isUpperCase(prev = chars[i - 1]) &amp;&amp; isLowerCase(cur = chars[i])) {</span>
<span class="fc" id="L350">            b.append(toLowerCase(prev2)).append('_').append(toLowerCase(prev)).append(cur);</span>
<span class="fc" id="L351">            return 0;</span>
        } else {
<span class="fc" id="L353">            b.append(toLowerCase(prev2));</span>
<span class="fc" id="L354">            return 2;</span>
        }
    }
    
    private static boolean isUpperDigit(char c) {
<span class="fc bfc" id="L359" title="All 4 branches covered.">        return isUpperCase(c) || isDigit(c);</span>
    }
    private static boolean isLowerDigit(char c) {
<span class="fc bfc" id="L362" title="All 4 branches covered.">        return isLowerCase(c) || isDigit(c);</span>
    }
    private static boolean isLetterDigit(char c) {
<span class="fc bfc" id="L365" title="All 4 branches covered.">        return isLetter(c) || isDigit(c);</span>
    }

<span class="fc" id="L368">    private static final Pattern RUBY_CASE_SPLITTER = Pattern.compile(&quot;([a-z][0-9]*)_([a-z])&quot;);</span>
    public static String getJavaCasedName(String javaCasedName) {
<span class="nc" id="L370">        Matcher m = RUBY_CASE_SPLITTER.matcher(javaCasedName);</span>
<span class="nc" id="L371">        StringBuffer newName = new StringBuffer();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (!m.find()) {</span>
<span class="nc" id="L373">            return null;</span>
        }
<span class="nc" id="L375">        m.reset();</span>

<span class="nc bnc" id="L377" title="All 2 branches missed.">        while (m.find()) {</span>
<span class="nc" id="L378">            m.appendReplacement(newName, m.group(1) + Character.toUpperCase(m.group(2).charAt(0)));</span>
        }

<span class="nc" id="L381">        m.appendTail(newName);</span>

<span class="nc" id="L383">        return newName.toString();</span>
    }

    /**
     * Given a simple Java method name and the Java Method objects that represent
     * all its overloads, add to the given nameSet all possible Ruby names that would
     * be valid.
     *
     * @param javaName
     * @param methods
     */
    public static Set&lt;String&gt; getRubyNamesForJavaName(String javaName, List&lt;Method&gt; methods) {
<span class="nc" id="L395">        String javaPropertyName = JavaUtil.getJavaPropertyName(javaName);</span>
<span class="nc" id="L396">        String rubyName = JavaUtil.getRubyCasedName(javaName);</span>
<span class="nc" id="L397">        Set&lt;String&gt; nameSet = new LinkedHashSet&lt;String&gt;();</span>
<span class="nc" id="L398">        nameSet.add(javaName);</span>
<span class="nc" id="L399">        nameSet.add(rubyName);</span>
<span class="nc" id="L400">        String rubyPropertyName = null;</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">        for (Method method: methods) {</span>
<span class="nc" id="L402">            Class&lt;?&gt;[] argTypes = method.getParameterTypes();</span>
<span class="nc" id="L403">            Class&lt;?&gt; resultType = method.getReturnType();</span>
<span class="nc" id="L404">            int argCount = argTypes.length;</span>

            // Add property name aliases
<span class="nc bnc" id="L407" title="All 2 branches missed.">            if (javaPropertyName != null) {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                if (rubyName.startsWith(&quot;get_&quot;)) {</span>
<span class="nc" id="L409">                    rubyPropertyName = rubyName.substring(4);</span>
<span class="nc bnc" id="L410" title="All 6 branches missed.">                    if (argCount == 0 ||                                // getFoo      =&gt; foo</span>
                        argCount == 1 &amp;&amp; argTypes[0] == int.class) {    // getFoo(int) =&gt; foo(int)

<span class="nc" id="L413">                        nameSet.add(javaPropertyName);</span>
<span class="nc" id="L414">                        nameSet.add(rubyPropertyName);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                        if (resultType == boolean.class) {              // getFooBar() =&gt; fooBar?, foo_bar?(*)</span>
<span class="nc" id="L416">                            nameSet.add(javaPropertyName + '?');</span>
<span class="nc" id="L417">                            nameSet.add(rubyPropertyName + '?');</span>
                        }
                    }
<span class="nc bnc" id="L420" title="All 2 branches missed.">                } else if (rubyName.startsWith(&quot;set_&quot;)) {</span>
<span class="nc" id="L421">                    rubyPropertyName = rubyName.substring(4);</span>
<span class="nc bnc" id="L422" title="All 4 branches missed.">                    if (argCount == 1 &amp;&amp; resultType == void.class) {    // setFoo(Foo) =&gt; foo=(Foo)</span>
<span class="nc" id="L423">                        nameSet.add(javaPropertyName + '=');</span>
<span class="nc" id="L424">                        nameSet.add(rubyPropertyName + '=');</span>
                    }
<span class="nc bnc" id="L426" title="All 2 branches missed.">                } else if (rubyName.startsWith(&quot;is_&quot;)) {</span>
<span class="nc" id="L427">                    rubyPropertyName = rubyName.substring(3);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">                    if (resultType == boolean.class) {                  // isFoo() =&gt; foo, isFoo(*) =&gt; foo(*)</span>
<span class="nc" id="L429">                        nameSet.add(javaPropertyName);</span>
<span class="nc" id="L430">                        nameSet.add(rubyPropertyName);</span>
<span class="nc" id="L431">                        nameSet.add(javaPropertyName + '?');</span>
<span class="nc" id="L432">                        nameSet.add(rubyPropertyName + '?');</span>
                    }
                }
            } else {
                // If not a property, but is boolean add ?-postfixed aliases.
<span class="nc bnc" id="L437" title="All 2 branches missed.">                if (resultType == boolean.class) {</span>
                    // is_something?, contains_thing?
<span class="nc" id="L439">                    nameSet.add(javaName + '?');</span>
<span class="nc" id="L440">                    nameSet.add(rubyName + '?');</span>
                }
            }
<span class="nc" id="L443">        }</span>

<span class="nc" id="L445">        return nameSet;</span>
    }
    
    public static abstract class JavaConverter {
        private final Class type;
<span class="fc" id="L450">        public JavaConverter(Class type) {this.type = type;}</span>
        public abstract IRubyObject convert(Ruby runtime, Object object);
        public abstract IRubyObject get(Ruby runtime, Object array, int i);
        public abstract void set(Ruby runtime, Object array, int i, IRubyObject value);
<span class="nc" id="L454">        public String toString() {return type.getName() + &quot; converter&quot;;}</span>
    }

    public interface NumericConverter {
        public Object coerce(RubyNumeric numeric, Class target);
    }

    private static IRubyObject trySimpleConversions(Ruby runtime, Object object) {
<span class="fc bfc" id="L462" title="All 2 branches covered.">        if (object == null) {</span>
<span class="fc" id="L463">            return runtime.getNil();</span>
        }

<span class="fc bfc" id="L466" title="All 2 branches covered.">        if (object instanceof IRubyObject) {</span>
<span class="fc" id="L467">            return (IRubyObject) object;</span>
        }

<span class="pc bpc" id="L470" title="1 of 2 branches missed.">        if (object instanceof RubyObjectHolderProxy) {</span>
<span class="nc" id="L471">            return ((RubyObjectHolderProxy) object).__ruby_object();</span>
        }

<span class="pc bpc" id="L474" title="1 of 2 branches missed.">        if (object instanceof InternalJavaProxy) {</span>
<span class="nc" id="L475">            InternalJavaProxy internalJavaProxy = (InternalJavaProxy) object;</span>
<span class="nc" id="L476">            IRubyObject orig = internalJavaProxy.___getInvocationHandler().getOrig();</span>

<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (orig != null) {</span>
<span class="nc" id="L479">                return orig;</span>
            }
        }

<span class="fc" id="L483">        return null;</span>
    }
    
<span class="fc" id="L486">    private static final JavaConverter JAVA_DEFAULT_CONVERTER = new JavaConverter(Object.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc" id="L488">            IRubyObject result = trySimpleConversions(runtime, object);</span>

<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (result != null) return result;</span>
            
<span class="nc" id="L492">            return JavaObject.wrap(runtime, object);</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L495">            return convert(runtime, ((Object[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L498">            ((Object[])array)[i] = value.toJava(Object.class);</span>
<span class="nc" id="L499">        }</span>
    };
    
<span class="fc" id="L502">    private static final JavaConverter JAVA_BOOLEAN_CONVERTER = new JavaConverter(Boolean.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L505">            return RubyBoolean.newBoolean(runtime, ((Boolean)object).booleanValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L508">            return convert(runtime, ((Boolean[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L511">            ((Boolean[])array)[i] = (Boolean)value.toJava(Boolean.class);</span>
<span class="nc" id="L512">        }</span>
    };
    
<span class="fc" id="L515">    private static final JavaConverter JAVA_FLOAT_CONVERTER = new JavaConverter(Float.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L517" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L518">            return RubyFloat.newFloat(runtime, ((Float)object).doubleValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L521">            return convert(runtime, ((Float[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L524">            ((Float[])array)[i] = (Float)value.toJava(Float.class);</span>
<span class="nc" id="L525">        }</span>
    };
    
<span class="fc" id="L528">    private static final JavaConverter JAVA_DOUBLE_CONVERTER = new JavaConverter(Double.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L530" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L531">            return RubyFloat.newFloat(runtime, ((Double)object).doubleValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L534">            return convert(runtime, ((Double[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L537">            ((Double[])array)[i] = (Double)value.toJava(Double.class);</span>
<span class="nc" id="L538">        }</span>
    };
    
<span class="fc" id="L541">    private static final JavaConverter JAVA_CHAR_CONVERTER = new JavaConverter(Character.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L543" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L544">            return RubyFixnum.newFixnum(runtime, ((Character)object).charValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L547">            return convert(runtime, ((Character[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L550">            ((Character[])array)[i] = (Character)value.toJava(Character.class);</span>
<span class="nc" id="L551">        }</span>
    };
    
<span class="fc" id="L554">    private static final JavaConverter JAVA_BYTE_CONVERTER = new JavaConverter(Byte.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L557">            return RubyFixnum.newFixnum(runtime, ((Byte)object).byteValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L560">            return convert(runtime, ((Byte[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L563">            ((Byte[])array)[i] = (Byte)value.toJava(Byte.class);</span>
<span class="nc" id="L564">        }</span>
    };
    
<span class="fc" id="L567">    private static final JavaConverter JAVA_SHORT_CONVERTER = new JavaConverter(Short.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L569" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L570">            return RubyFixnum.newFixnum(runtime, ((Short)object).shortValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L573">            return convert(runtime, ((Short[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L576">            ((Short[])array)[i] = (Short)value.toJava(Short.class);</span>
<span class="nc" id="L577">        }</span>
    };
    
<span class="fc" id="L580">    private static final JavaConverter JAVA_INT_CONVERTER = new JavaConverter(Integer.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L583">            return RubyFixnum.newFixnum(runtime, ((Integer)object).intValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L586">            return convert(runtime, ((Integer[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L589">            ((Integer[])array)[i] = (Integer)value.toJava(Integer.class);</span>
<span class="nc" id="L590">        }</span>
    };
    
<span class="fc" id="L593">    private static final JavaConverter JAVA_LONG_CONVERTER = new JavaConverter(Long.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L595" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L596">            return RubyFixnum.newFixnum(runtime, ((Long)object).longValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L599">            return convert(runtime, ((Long[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L602">            ((Long[])array)[i] = (Long)value.toJava(Long.class);</span>
<span class="nc" id="L603">        }</span>
    };

<span class="fc" id="L606">    private static final JavaConverter JAVA_BOOLEANPRIM_CONVERTER = new JavaConverter(boolean.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L609">            return RubyBoolean.newBoolean(runtime, ((Boolean)object).booleanValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L612">            return RubyBoolean.newBoolean(runtime, ((boolean[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L615">            ((boolean[])array)[i] = (Boolean)value.toJava(boolean.class);</span>
<span class="nc" id="L616">        }</span>
    };

<span class="fc" id="L619">    private static final JavaConverter JAVA_FLOATPRIM_CONVERTER = new JavaConverter(float.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L621" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L622">            return RubyFloat.newFloat(runtime, ((Float)object).doubleValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L625">            return RubyFloat.newFloat(runtime, ((float[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L628">            ((float[])array)[i] = (Float)value.toJava(float.class);</span>
<span class="nc" id="L629">        }</span>
    };

<span class="fc" id="L632">    private static final JavaConverter JAVA_DOUBLEPRIM_CONVERTER = new JavaConverter(double.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L634" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L635">            return RubyFloat.newFloat(runtime, ((Double)object).doubleValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L638">            return RubyFloat.newFloat(runtime, ((double[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L641">            ((double[])array)[i] = (Double)value.toJava(double.class);</span>
<span class="nc" id="L642">        }</span>
    };

<span class="fc" id="L645">    private static final JavaConverter JAVA_CHARPRIM_CONVERTER = new JavaConverter(char.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L647" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L648">            return RubyFixnum.newFixnum(runtime, ((Character)object).charValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L651">            return RubyFixnum.newFixnum(runtime, ((char[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L654">            ((char[])array)[i] = (Character)value.toJava(char.class);</span>
<span class="nc" id="L655">        }</span>
    };

<span class="fc" id="L658">    private static final JavaConverter JAVA_BYTEPRIM_CONVERTER = new JavaConverter(byte.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L660" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L661">            return RubyFixnum.newFixnum(runtime, ((Byte)object).byteValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L664">            return RubyFixnum.newFixnum(runtime, ((byte[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L667">            ((byte[])array)[i] = (Byte)value.toJava(byte.class);</span>
<span class="nc" id="L668">        }</span>
    };

<span class="fc" id="L671">    private static final JavaConverter JAVA_SHORTPRIM_CONVERTER = new JavaConverter(short.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L673" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L674">            return RubyFixnum.newFixnum(runtime, ((Short)object).shortValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L677">            return RubyFixnum.newFixnum(runtime, ((short[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L680">            ((short[])array)[i] = (Short)value.toJava(short.class);</span>
<span class="nc" id="L681">        }</span>
    };

<span class="fc" id="L684">    private static final JavaConverter JAVA_INTPRIM_CONVERTER = new JavaConverter(int.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L686" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L687">            return RubyFixnum.newFixnum(runtime, ((Integer)object).intValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L690">            return RubyFixnum.newFixnum(runtime, ((int[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L693">            ((int[])array)[i] = (Integer)value.toJava(int.class);</span>
<span class="nc" id="L694">        }</span>
    };

<span class="fc" id="L697">    private static final JavaConverter JAVA_LONGPRIM_CONVERTER = new JavaConverter(long.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L699" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L700">            return RubyFixnum.newFixnum(runtime, ((Long)object).longValue());</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L703">            return RubyFixnum.newFixnum(runtime, ((long[])array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L706">            ((long[])array)[i] = (Long)value.toJava(long.class);</span>
<span class="nc" id="L707">        }</span>
    };
    
<span class="fc" id="L710">    private static final JavaConverter JAVA_STRING_CONVERTER = new JavaConverter(String.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="fc" id="L713">            return RubyString.newUnicodeString(runtime, (String)object);</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L716">            return convert(runtime, ((String[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L719">            ((String[])array)[i] = (String)value.toJava(String.class);</span>
<span class="nc" id="L720">        }</span>
    };
    
<span class="fc" id="L723">    private static final JavaConverter JAVA_CHARSEQUENCE_CONVERTER = new JavaConverter(String.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L725" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L726">            return RubyString.newUnicodeString(runtime, (CharSequence)object);</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L729">            return convert(runtime, ((CharSequence[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L732">            ((CharSequence[])array)[i] = (CharSequence)value.toJava(CharSequence.class);</span>
<span class="nc" id="L733">        }</span>
    };
    
<span class="fc" id="L736">    private static final JavaConverter BYTELIST_CONVERTER = new JavaConverter(ByteList.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L738" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L739">            return RubyString.newString(runtime, (ByteList)object);</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L742">            return convert(runtime, ((ByteList[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L745">            ((ByteList[])array)[i] = (ByteList)value.toJava(ByteList.class);</span>
<span class="nc" id="L746">        }</span>
    };
    
<span class="fc" id="L749">    private static final JavaConverter JAVA_BIGINTEGER_CONVERTER = new JavaConverter(BigInteger.class) {</span>
        public IRubyObject convert(Ruby runtime, Object object) {
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (object == null) return runtime.getNil();</span>
<span class="nc" id="L752">            return RubyBignum.newBignum(runtime, (BigInteger)object);</span>
        }
        public IRubyObject get(Ruby runtime, Object array, int i) {
<span class="nc" id="L755">            return convert(runtime, ((BigInteger[]) array)[i]);</span>
        }
        public void set(Ruby runtime, Object array, int i, IRubyObject value) {
<span class="nc" id="L758">            ((BigInteger[])array)[i] = (BigInteger)value.toJava(BigInteger.class);</span>
<span class="nc" id="L759">        }</span>
    };
    
<span class="fc" id="L762">    private static final Map&lt;Class,JavaConverter&gt; JAVA_CONVERTERS =</span>
        new HashMap&lt;Class,JavaConverter&gt;();
    
    static {
<span class="fc" id="L766">        JAVA_CONVERTERS.put(Byte.class, JAVA_BYTE_CONVERTER);</span>
<span class="fc" id="L767">        JAVA_CONVERTERS.put(Byte.TYPE, JAVA_BYTEPRIM_CONVERTER);</span>
<span class="fc" id="L768">        JAVA_CONVERTERS.put(Short.class, JAVA_SHORT_CONVERTER);</span>
<span class="fc" id="L769">        JAVA_CONVERTERS.put(Short.TYPE, JAVA_SHORTPRIM_CONVERTER);</span>
<span class="fc" id="L770">        JAVA_CONVERTERS.put(Character.class, JAVA_CHAR_CONVERTER);</span>
<span class="fc" id="L771">        JAVA_CONVERTERS.put(Character.TYPE, JAVA_CHARPRIM_CONVERTER);</span>
<span class="fc" id="L772">        JAVA_CONVERTERS.put(Integer.class, JAVA_INT_CONVERTER);</span>
<span class="fc" id="L773">        JAVA_CONVERTERS.put(Integer.TYPE, JAVA_INTPRIM_CONVERTER);</span>
<span class="fc" id="L774">        JAVA_CONVERTERS.put(Long.class, JAVA_LONG_CONVERTER);</span>
<span class="fc" id="L775">        JAVA_CONVERTERS.put(Long.TYPE, JAVA_LONGPRIM_CONVERTER);</span>
<span class="fc" id="L776">        JAVA_CONVERTERS.put(Float.class, JAVA_FLOAT_CONVERTER);</span>
<span class="fc" id="L777">        JAVA_CONVERTERS.put(Float.TYPE, JAVA_FLOATPRIM_CONVERTER);</span>
<span class="fc" id="L778">        JAVA_CONVERTERS.put(Double.class, JAVA_DOUBLE_CONVERTER);</span>
<span class="fc" id="L779">        JAVA_CONVERTERS.put(Double.TYPE, JAVA_DOUBLEPRIM_CONVERTER);</span>
<span class="fc" id="L780">        JAVA_CONVERTERS.put(Boolean.class, JAVA_BOOLEAN_CONVERTER);</span>
<span class="fc" id="L781">        JAVA_CONVERTERS.put(Boolean.TYPE, JAVA_BOOLEANPRIM_CONVERTER);</span>
        
<span class="fc" id="L783">        JAVA_CONVERTERS.put(String.class, JAVA_STRING_CONVERTER);</span>
<span class="fc" id="L784">        JAVA_CONVERTERS.put(CharSequence.class, JAVA_CHARSEQUENCE_CONVERTER);</span>
        
<span class="fc" id="L786">        JAVA_CONVERTERS.put(ByteList.class, BYTELIST_CONVERTER);</span>
        
<span class="fc" id="L788">        JAVA_CONVERTERS.put(BigInteger.class, JAVA_BIGINTEGER_CONVERTER);</span>
    }

<span class="fc" id="L791">    private static final NumericConverter NUMERIC_TO_BYTE = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L793">            long value = numeric.getLongValue();</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">            if (isLongByteable(value)) {</span>
<span class="nc" id="L795">                return Byte.valueOf((byte)value);</span>
            }
<span class="nc" id="L797">            throw numeric.getRuntime().newRangeError(&quot;too big for byte: &quot; + numeric);</span>
        }
    };
<span class="fc" id="L800">    private static final NumericConverter NUMERIC_TO_SHORT = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L802">            long value = numeric.getLongValue();</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">            if (isLongShortable(value)) {</span>
<span class="nc" id="L804">                return Short.valueOf((short)value);</span>
            }
<span class="nc" id="L806">            throw numeric.getRuntime().newRangeError(&quot;too big for short: &quot; + numeric);</span>
        }
    };
<span class="fc" id="L809">    private static final NumericConverter NUMERIC_TO_CHARACTER = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="fc" id="L811">            long value = numeric.getLongValue();</span>
<span class="pc bpc" id="L812" title="1 of 2 branches missed.">            if (isLongCharable(value)) {</span>
<span class="fc" id="L813">                return Character.valueOf((char)value);</span>
            }
<span class="nc" id="L815">            throw numeric.getRuntime().newRangeError(&quot;too big for char: &quot; + numeric);</span>
        }
    };
<span class="fc" id="L818">    private static final NumericConverter NUMERIC_TO_INTEGER = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L820">            long value = numeric.getLongValue();</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">            if (isLongIntable(value)) {</span>
<span class="nc" id="L822">                return Integer.valueOf((int)value);</span>
            }
<span class="nc" id="L824">            throw numeric.getRuntime().newRangeError(&quot;too big for int: &quot; + numeric);</span>
        }
    };
<span class="fc" id="L827">    private static final NumericConverter NUMERIC_TO_LONG = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L829">            return Long.valueOf(numeric.getLongValue());</span>
        }
    };
<span class="fc" id="L832">    private static final NumericConverter NUMERIC_TO_FLOAT = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L834">            double value = numeric.getDoubleValue();</span>
            // many cases are ok to convert to float; if not one of these, error
<span class="nc bnc" id="L836" title="All 2 branches missed.">            if (isDoubleFloatable(value)) {</span>
<span class="nc" id="L837">                return Float.valueOf((float)value);</span>
            } else {
<span class="nc" id="L839">                throw numeric.getRuntime().newTypeError(&quot;too big for float: &quot; + numeric);</span>
            }
        }
    };
<span class="fc" id="L843">    private static final NumericConverter NUMERIC_TO_DOUBLE = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L845">            return Double.valueOf(numeric.getDoubleValue());</span>
        }
    };
<span class="fc" id="L848">    private static final NumericConverter NUMERIC_TO_BIGINTEGER = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L850">            return numeric.getBigIntegerValue();</span>
        }
    };
<span class="fc" id="L853">    private static final NumericConverter NUMERIC_TO_OBJECT = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
            // for Object, default to natural wrapper type
<span class="nc bnc" id="L856" title="All 2 branches missed.">            if (numeric instanceof RubyFixnum) {</span>
<span class="nc" id="L857">                long value = numeric.getLongValue();</span>
<span class="nc" id="L858">                return Long.valueOf(value);</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">            } else if (numeric instanceof RubyFloat) {</span>
<span class="nc" id="L860">                double value = numeric.getDoubleValue();</span>
<span class="nc" id="L861">                return Double.valueOf(value);</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">            } else if (numeric instanceof RubyBignum) {</span>
<span class="nc" id="L863">                return ((RubyBignum)numeric).getValue();</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">            } else if (numeric instanceof RubyBigDecimal) {</span>
<span class="nc" id="L865">                return ((RubyBigDecimal)numeric).getValue();</span>
            } else {
<span class="nc" id="L867">                return NUMERIC_TO_OTHER.coerce(numeric, target);</span>
            }
        }
    };
<span class="fc" id="L871">    private static final NumericConverter NUMERIC_TO_OTHER = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc bnc" id="L873" title="All 2 branches missed.">            if (target.isAssignableFrom(numeric.getClass())) {</span>
                // just return as-is, since we can't do any coercion
<span class="nc" id="L875">                return numeric;</span>
            }
            // otherwise, error; no conversion available
<span class="nc" id="L878">            throw numeric.getRuntime().newTypeError(&quot;could not coerce &quot; + numeric.getMetaClass() + &quot; to &quot; + target);</span>
        }
    };
<span class="fc" id="L881">    private static final NumericConverter NUMERIC_TO_VOID = new NumericConverter() {</span>
        public Object coerce(RubyNumeric numeric, Class target) {
<span class="nc" id="L883">            return null;</span>
        }
    };
    private static boolean isDoubleFloatable(double value) {
<span class="nc" id="L887">        return true;</span>
    }
    private static boolean isLongByteable(long value) {
<span class="nc bnc" id="L890" title="All 4 branches missed.">        return value &gt;= Byte.MIN_VALUE &amp;&amp; value &lt;= Byte.MAX_VALUE;</span>
    }
    private static boolean isLongShortable(long value) {
<span class="nc bnc" id="L893" title="All 4 branches missed.">        return value &gt;= Short.MIN_VALUE &amp;&amp; value &lt;= Short.MAX_VALUE;</span>
    }
    private static boolean isLongCharable(long value) {
<span class="pc bpc" id="L896" title="2 of 4 branches missed.">        return value &gt;= Character.MIN_VALUE &amp;&amp; value &lt;= Character.MAX_VALUE;</span>
    }
    private static boolean isLongIntable(long value) {
<span class="nc bnc" id="L899" title="All 4 branches missed.">        return value &gt;= Integer.MIN_VALUE &amp;&amp; value &lt;= Integer.MAX_VALUE;</span>
    }
    
<span class="fc" id="L902">    private static final Map&lt;Class, NumericConverter&gt; NUMERIC_CONVERTERS = new HashMap&lt;Class, NumericConverter&gt;();</span>

    static {
<span class="fc" id="L905">        NUMERIC_CONVERTERS.put(Byte.TYPE, NUMERIC_TO_BYTE);</span>
<span class="fc" id="L906">        NUMERIC_CONVERTERS.put(Byte.class, NUMERIC_TO_BYTE);</span>
<span class="fc" id="L907">        NUMERIC_CONVERTERS.put(Short.TYPE, NUMERIC_TO_SHORT);</span>
<span class="fc" id="L908">        NUMERIC_CONVERTERS.put(Short.class, NUMERIC_TO_SHORT);</span>
<span class="fc" id="L909">        NUMERIC_CONVERTERS.put(Character.TYPE, NUMERIC_TO_CHARACTER);</span>
<span class="fc" id="L910">        NUMERIC_CONVERTERS.put(Character.class, NUMERIC_TO_CHARACTER);</span>
<span class="fc" id="L911">        NUMERIC_CONVERTERS.put(Integer.TYPE, NUMERIC_TO_INTEGER);</span>
<span class="fc" id="L912">        NUMERIC_CONVERTERS.put(Integer.class, NUMERIC_TO_INTEGER);</span>
<span class="fc" id="L913">        NUMERIC_CONVERTERS.put(Long.TYPE, NUMERIC_TO_LONG);</span>
<span class="fc" id="L914">        NUMERIC_CONVERTERS.put(Long.class, NUMERIC_TO_LONG);</span>
<span class="fc" id="L915">        NUMERIC_CONVERTERS.put(Float.TYPE, NUMERIC_TO_FLOAT);</span>
<span class="fc" id="L916">        NUMERIC_CONVERTERS.put(Float.class, NUMERIC_TO_FLOAT);</span>
<span class="fc" id="L917">        NUMERIC_CONVERTERS.put(Double.TYPE, NUMERIC_TO_DOUBLE);</span>
<span class="fc" id="L918">        NUMERIC_CONVERTERS.put(Double.class, NUMERIC_TO_DOUBLE);</span>
<span class="fc" id="L919">        NUMERIC_CONVERTERS.put(BigInteger.class, NUMERIC_TO_BIGINTEGER);</span>
<span class="fc" id="L920">        NUMERIC_CONVERTERS.put(Object.class, NUMERIC_TO_OBJECT);</span>
<span class="fc" id="L921">        NUMERIC_CONVERTERS.put(Number.class, NUMERIC_TO_OBJECT);</span>
<span class="fc" id="L922">        NUMERIC_CONVERTERS.put(Serializable.class, NUMERIC_TO_OBJECT);</span>
<span class="fc" id="L923">        NUMERIC_CONVERTERS.put(void.class, NUMERIC_TO_VOID);</span>
    }
    
    public static Object objectFromJavaProxy(IRubyObject self) {
<span class="nc" id="L927">        return ((JavaProxy)self).getObject();</span>
    }

    @Deprecated
    public static Object convertRubyToJava(IRubyObject rubyObject) {
<span class="nc" id="L932">        return convertRubyToJava(rubyObject, Object.class);</span>
    }

    @Deprecated
    public static Object convertRubyToJava(IRubyObject rubyObject, Class javaClass) {
<span class="nc bnc" id="L937" title="All 6 branches missed.">        if (javaClass == void.class || rubyObject == null || rubyObject.isNil()) {</span>
<span class="nc" id="L938">            return null;</span>
        }

<span class="nc" id="L941">        ThreadContext context = rubyObject.getRuntime().getCurrentContext();</span>
<span class="nc" id="L942">        IRubyObject origObject = rubyObject;</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">        if (rubyObject.dataGetStruct() instanceof JavaObject) {</span>
<span class="nc" id="L944">            rubyObject = (IRubyObject)rubyObject.dataGetStruct();</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">            if(rubyObject == null) {</span>
<span class="nc" id="L946">                throw new RuntimeException(&quot;dataGetStruct returned null for &quot; + origObject.getType().getName());</span>
            }
<span class="nc bnc" id="L948" title="All 2 branches missed.">        } else if (rubyObject.respondsTo(&quot;java_object&quot;)) {</span>
<span class="nc" id="L949">            rubyObject = rubyObject.callMethod(context, &quot;java_object&quot;);</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">            if(rubyObject == null) {</span>
<span class="nc" id="L951">                throw new RuntimeException(&quot;java_object returned null for &quot; + origObject.getType().getName());</span>
            }
        }

<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (rubyObject instanceof JavaObject) {</span>
<span class="nc" id="L956">            Object value =  ((JavaObject) rubyObject).getValue();</span>

<span class="nc" id="L958">            return convertArgument(rubyObject.getRuntime(), value, value.getClass());</span>

<span class="nc bnc" id="L960" title="All 4 branches missed.">        } else if (javaClass == Object.class || javaClass == null) {</span>
            /* The Java method doesn't care what class it is, but we need to
               know what to convert it to, so we use the object's own class.
               If that doesn't help, we use String to force a call to the
               object's &quot;to_s&quot; method. */
<span class="nc" id="L965">            javaClass = rubyObject.getJavaClass();</span>
        }

<span class="nc bnc" id="L968" title="All 2 branches missed.">        if (javaClass.isInstance(rubyObject)) {</span>
            // rubyObject is already of the required jruby class (or subclass)
<span class="nc" id="L970">            return rubyObject;</span>
        }

        // the converters handle not only primitive types but also their boxed versions, so we should check
        // if we have a converter before checking for isPrimitive()
<span class="nc" id="L975">        RubyConverter converter = RUBY_CONVERTERS.get(javaClass);</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">        if (converter != null) {</span>
<span class="nc" id="L977">            return converter.convert(context, rubyObject);</span>
        }

<span class="nc bnc" id="L980" title="All 2 branches missed.">        if (javaClass.isPrimitive()) {</span>
<span class="nc" id="L981">            String s = ((RubyString)TypeConverter.convertToType(rubyObject, rubyObject.getRuntime().getString(), &quot;to_s&quot;, true)).getUnicodeValue();</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">            if (s.length() &gt; 0) {</span>
<span class="nc" id="L983">                return Character.valueOf(s.charAt(0));</span>
            }
<span class="nc" id="L985">            return Character.valueOf('\0');</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">        } else if (javaClass == String.class) {</span>
<span class="nc" id="L987">            RubyString rubyString = (RubyString) rubyObject.callMethod(context, &quot;to_s&quot;);</span>
<span class="nc" id="L988">            ByteList bytes = rubyString.getByteList();</span>
<span class="nc" id="L989">            return RubyEncoding.decodeUTF8(bytes.getUnsafeBytes(), bytes.begin(), bytes.length());</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">        } else if (javaClass == ByteList.class) {</span>
<span class="nc" id="L991">            return rubyObject.convertToString().getByteList();</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">        } else if (javaClass == BigInteger.class) {</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">         	if (rubyObject instanceof RubyBignum) {</span>
<span class="nc" id="L994">         		return ((RubyBignum)rubyObject).getValue();</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">         	} else if (rubyObject instanceof RubyNumeric) {</span>
<span class="nc" id="L996"> 				return  BigInteger.valueOf (((RubyNumeric)rubyObject).getLongValue());</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">         	} else if (rubyObject.respondsTo(&quot;to_i&quot;)) {</span>
<span class="nc" id="L998">         		RubyNumeric rubyNumeric = ((RubyNumeric)rubyObject.callMethod(context, &quot;to_f&quot;));</span>
<span class="nc" id="L999"> 				return  BigInteger.valueOf (rubyNumeric.getLongValue());</span>
         	}
<span class="nc bnc" id="L1001" title="All 4 branches missed.">        } else if (javaClass == BigDecimal.class &amp;&amp; !(rubyObject instanceof JavaObject)) {</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">         	if (rubyObject.respondsTo(&quot;to_f&quot;)) {</span>
<span class="nc" id="L1003">             	double double_value = ((RubyNumeric)rubyObject.callMethod(context, &quot;to_f&quot;)).getDoubleValue();</span>
<span class="nc" id="L1004">             	return new BigDecimal(double_value);</span>
         	}
        }

        try {
<span class="nc bnc" id="L1009" title="All 2 branches missed.">            if (isDuckTypeConvertable(rubyObject.getClass(), javaClass)) {</span>
<span class="nc" id="L1010">                return convertProcToInterface(context, (RubyObject) rubyObject, javaClass);</span>
            }
<span class="nc" id="L1012">            return ((JavaObject) rubyObject).getValue();</span>
<span class="nc" id="L1013">        } catch (ClassCastException ex) {</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">            if (rubyObject.getRuntime().getDebug().isTrue()) ex.printStackTrace();</span>
<span class="nc" id="L1015">            return null;</span>
        }
    }

    @Deprecated
    public static byte convertRubyToJavaByte(IRubyObject rubyObject) {
<span class="nc" id="L1021">        return ((Byte)convertRubyToJava(rubyObject, byte.class)).byteValue();</span>
    }

    @Deprecated
    public static short convertRubyToJavaShort(IRubyObject rubyObject) {
<span class="nc" id="L1026">        return ((Short)convertRubyToJava(rubyObject, short.class)).shortValue();</span>
    }

    @Deprecated
    public static char convertRubyToJavaChar(IRubyObject rubyObject) {
<span class="nc" id="L1031">        return ((Character)convertRubyToJava(rubyObject, char.class)).charValue();</span>
    }

    @Deprecated
    public static int convertRubyToJavaInt(IRubyObject rubyObject) {
<span class="nc" id="L1036">        return ((Integer)convertRubyToJava(rubyObject, int.class)).intValue();</span>
    }

    @Deprecated
    public static long convertRubyToJavaLong(IRubyObject rubyObject) {
<span class="nc" id="L1041">        return ((Long)convertRubyToJava(rubyObject, long.class)).longValue();</span>
    }

    @Deprecated
    public static float convertRubyToJavaFloat(IRubyObject rubyObject) {
<span class="nc" id="L1046">        return ((Float)convertRubyToJava(rubyObject, float.class)).floatValue();</span>
    }

    @Deprecated
    public static double convertRubyToJavaDouble(IRubyObject rubyObject) {
<span class="nc" id="L1051">        return ((Double)convertRubyToJava(rubyObject, double.class)).doubleValue();</span>
    }

    @Deprecated
    public static boolean convertRubyToJavaBoolean(IRubyObject rubyObject) {
<span class="nc" id="L1056">        return ((Boolean)convertRubyToJava(rubyObject, boolean.class)).booleanValue();</span>
    }

    @Deprecated
    public static Object convertArgumentToType(ThreadContext context, IRubyObject arg, Class target) {
<span class="nc" id="L1061">        return arg.toJava(target);</span>
    }

    @Deprecated
    public static Object coerceNilToType(RubyNil nil, Class target) {
<span class="nc" id="L1066">        return nil.toJava(target);</span>
    }

    @Deprecated
<span class="fc" id="L1070">    public static final RubyConverter RUBY_BOOLEAN_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1072">            return Boolean.valueOf(rubyObject.isTrue());</span>
        }
    };

    @Deprecated
<span class="fc" id="L1077">    public static final RubyConverter RUBY_BYTE_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc bnc" id="L1079" title="All 2 branches missed.">            if (rubyObject.respondsTo(&quot;to_i&quot;)) {</span>
<span class="nc" id="L1080">                return Byte.valueOf((byte) ((RubyNumeric) rubyObject.callMethod(</span>
<span class="nc" id="L1081">                        context, &quot;to_i&quot;)).getLongValue());</span>
            }
<span class="nc" id="L1083">            return Byte.valueOf((byte) 0);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1088">    public static final RubyConverter RUBY_SHORT_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc bnc" id="L1090" title="All 2 branches missed.">            if (rubyObject.respondsTo(&quot;to_i&quot;)) {</span>
<span class="nc" id="L1091">                return Short.valueOf((short) ((RubyNumeric) rubyObject.callMethod(</span>
<span class="nc" id="L1092">                        context, &quot;to_i&quot;)).getLongValue());</span>
            }
<span class="nc" id="L1094">            return Short.valueOf((short) 0);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1099">    public static final RubyConverter RUBY_CHAR_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc bnc" id="L1101" title="All 2 branches missed.">            if (rubyObject.respondsTo(&quot;to_i&quot;)) {</span>
<span class="nc" id="L1102">                return Character.valueOf((char) ((RubyNumeric) rubyObject.callMethod(</span>
<span class="nc" id="L1103">                        context, &quot;to_i&quot;)).getLongValue());</span>
            }
<span class="nc" id="L1105">            return Character.valueOf((char) 0);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1110">    public static final RubyConverter RUBY_INTEGER_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc bnc" id="L1112" title="All 2 branches missed.">            if (rubyObject.respondsTo(&quot;to_i&quot;)) {</span>
<span class="nc" id="L1113">                return Integer.valueOf((int) ((RubyNumeric) rubyObject.callMethod(</span>
<span class="nc" id="L1114">                        context, &quot;to_i&quot;)).getLongValue());</span>
            }
<span class="nc" id="L1116">            return Integer.valueOf(0);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1121">    public static final RubyConverter RUBY_LONG_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc bnc" id="L1123" title="All 2 branches missed.">            if (rubyObject.respondsTo(&quot;to_i&quot;)) {</span>
<span class="nc" id="L1124">                return Long.valueOf(((RubyNumeric) rubyObject.callMethod(</span>
<span class="nc" id="L1125">                        context, &quot;to_i&quot;)).getLongValue());</span>
            }
<span class="nc" id="L1127">            return Long.valueOf(0);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1132">    public static final RubyConverter RUBY_FLOAT_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc bnc" id="L1134" title="All 2 branches missed.">            if (rubyObject.respondsTo(&quot;to_f&quot;)) {</span>
<span class="nc" id="L1135">                return new Float((float) ((RubyNumeric) rubyObject.callMethod(</span>
<span class="nc" id="L1136">                        context, &quot;to_f&quot;)).getDoubleValue());</span>
            }
<span class="nc" id="L1138">            return new Float(0.0);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1143">    public static final RubyConverter RUBY_DOUBLE_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc bnc" id="L1145" title="All 2 branches missed.">            if (rubyObject.respondsTo(&quot;to_f&quot;)) {</span>
<span class="nc" id="L1146">                return new Double(((RubyNumeric) rubyObject.callMethod(</span>
<span class="nc" id="L1147">                        context, &quot;to_f&quot;)).getDoubleValue());</span>
            }
<span class="nc" id="L1149">            return new Double(0.0);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1154">    public static final Map&lt;Class, RubyConverter&gt; RUBY_CONVERTERS = new HashMap&lt;Class, RubyConverter&gt;();</span>
    static {
<span class="fc" id="L1156">        RUBY_CONVERTERS.put(Boolean.class, RUBY_BOOLEAN_CONVERTER);</span>
<span class="fc" id="L1157">        RUBY_CONVERTERS.put(Boolean.TYPE, RUBY_BOOLEAN_CONVERTER);</span>
<span class="fc" id="L1158">        RUBY_CONVERTERS.put(Byte.class, RUBY_BYTE_CONVERTER);</span>
<span class="fc" id="L1159">        RUBY_CONVERTERS.put(Byte.TYPE, RUBY_BYTE_CONVERTER);</span>
<span class="fc" id="L1160">        RUBY_CONVERTERS.put(Short.class, RUBY_SHORT_CONVERTER);</span>
<span class="fc" id="L1161">        RUBY_CONVERTERS.put(Short.TYPE, RUBY_SHORT_CONVERTER);</span>
<span class="fc" id="L1162">        RUBY_CONVERTERS.put(Integer.class, RUBY_INTEGER_CONVERTER);</span>
<span class="fc" id="L1163">        RUBY_CONVERTERS.put(Integer.TYPE, RUBY_INTEGER_CONVERTER);</span>
<span class="fc" id="L1164">        RUBY_CONVERTERS.put(Long.class, RUBY_LONG_CONVERTER);</span>
<span class="fc" id="L1165">        RUBY_CONVERTERS.put(Long.TYPE, RUBY_LONG_CONVERTER);</span>
<span class="fc" id="L1166">        RUBY_CONVERTERS.put(Float.class, RUBY_FLOAT_CONVERTER);</span>
<span class="fc" id="L1167">        RUBY_CONVERTERS.put(Float.TYPE, RUBY_FLOAT_CONVERTER);</span>
<span class="fc" id="L1168">        RUBY_CONVERTERS.put(Double.class, RUBY_DOUBLE_CONVERTER);</span>
<span class="fc" id="L1169">        RUBY_CONVERTERS.put(Double.TYPE, RUBY_DOUBLE_CONVERTER);</span>
    }

    @Deprecated
    public static IRubyObject convertJavaToRuby(Ruby runtime, JavaConverter converter, Object object) {
<span class="nc bnc" id="L1174" title="All 4 branches missed.">        if (converter == null || converter == JAVA_DEFAULT_CONVERTER) {</span>
<span class="nc" id="L1175">            return Java.getInstance(runtime, object);</span>
        }
<span class="nc" id="L1177">        return converter.convert(runtime, object);</span>
    }

<span class="nc" id="L1180">    @Deprecated</span>
    public interface RubyConverter {
        public Object convert(ThreadContext context, IRubyObject rubyObject);
    }

    @Deprecated
<span class="fc" id="L1186">    public static final RubyConverter ARRAY_BOOLEAN_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1188">            return rubyObject.toJava(Boolean.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1193">    public static final RubyConverter ARRAY_BYTE_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1195">            return rubyObject.toJava(Byte.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1200">    public static final RubyConverter ARRAY_SHORT_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1202">            return rubyObject.toJava(Short.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1207">    public static final RubyConverter ARRAY_CHAR_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1209">            return rubyObject.toJava(Character.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1214">    public static final RubyConverter ARRAY_INT_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1216">            return rubyObject.toJava(Integer.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1221">    public static final RubyConverter ARRAY_LONG_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1223">            return rubyObject.toJava(Long.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1228">    public static final RubyConverter ARRAY_FLOAT_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1230">            return rubyObject.toJava(Float.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1235">    public static final RubyConverter ARRAY_DOUBLE_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1237">            return rubyObject.toJava(Double.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1242">    public static final RubyConverter ARRAY_OBJECT_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1244">            return rubyObject.toJava(Object.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1249">    public static final RubyConverter ARRAY_CLASS_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1251">            return rubyObject.toJava(Class.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1256">    public static final RubyConverter ARRAY_STRING_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1258">            return rubyObject.toJava(String.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1263">    public static final RubyConverter ARRAY_BIGINTEGER_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1265">            return rubyObject.toJava(BigInteger.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1270">    public static final RubyConverter ARRAY_BIGDECIMAL_CONVERTER = new RubyConverter() {</span>
        public Object convert(ThreadContext context, IRubyObject rubyObject) {
<span class="nc" id="L1272">            return rubyObject.toJava(BigDecimal.class);</span>
        }
    };

    @Deprecated
<span class="fc" id="L1277">    public static final Map&lt;Class, RubyConverter&gt; ARRAY_CONVERTERS = new HashMap&lt;Class, RubyConverter&gt;();</span>
    static {
<span class="fc" id="L1279">        ARRAY_CONVERTERS.put(Boolean.class, ARRAY_BOOLEAN_CONVERTER);</span>
<span class="fc" id="L1280">        ARRAY_CONVERTERS.put(Boolean.TYPE, ARRAY_BOOLEAN_CONVERTER);</span>
<span class="fc" id="L1281">        ARRAY_CONVERTERS.put(Byte.class, ARRAY_BYTE_CONVERTER);</span>
<span class="fc" id="L1282">        ARRAY_CONVERTERS.put(Byte.TYPE, ARRAY_BYTE_CONVERTER);</span>
<span class="fc" id="L1283">        ARRAY_CONVERTERS.put(Short.class, ARRAY_SHORT_CONVERTER);</span>
<span class="fc" id="L1284">        ARRAY_CONVERTERS.put(Short.TYPE, ARRAY_SHORT_CONVERTER);</span>
<span class="fc" id="L1285">        ARRAY_CONVERTERS.put(Character.class, ARRAY_CHAR_CONVERTER);</span>
<span class="fc" id="L1286">        ARRAY_CONVERTERS.put(Character.TYPE, ARRAY_CHAR_CONVERTER);</span>
<span class="fc" id="L1287">        ARRAY_CONVERTERS.put(Integer.class, ARRAY_INT_CONVERTER);</span>
<span class="fc" id="L1288">        ARRAY_CONVERTERS.put(Integer.TYPE, ARRAY_INT_CONVERTER);</span>
<span class="fc" id="L1289">        ARRAY_CONVERTERS.put(Long.class, ARRAY_LONG_CONVERTER);</span>
<span class="fc" id="L1290">        ARRAY_CONVERTERS.put(Long.TYPE, ARRAY_LONG_CONVERTER);</span>
<span class="fc" id="L1291">        ARRAY_CONVERTERS.put(Float.class, ARRAY_FLOAT_CONVERTER);</span>
<span class="fc" id="L1292">        ARRAY_CONVERTERS.put(Float.TYPE, ARRAY_FLOAT_CONVERTER);</span>
<span class="fc" id="L1293">        ARRAY_CONVERTERS.put(Double.class, ARRAY_DOUBLE_CONVERTER);</span>
<span class="fc" id="L1294">        ARRAY_CONVERTERS.put(Double.TYPE, ARRAY_DOUBLE_CONVERTER);</span>
<span class="fc" id="L1295">        ARRAY_CONVERTERS.put(String.class, ARRAY_STRING_CONVERTER);</span>
<span class="fc" id="L1296">        ARRAY_CONVERTERS.put(Class.class, ARRAY_CLASS_CONVERTER);</span>
<span class="fc" id="L1297">        ARRAY_CONVERTERS.put(BigInteger.class, ARRAY_BIGINTEGER_CONVERTER);</span>
<span class="fc" id="L1298">        ARRAY_CONVERTERS.put(BigDecimal.class, ARRAY_BIGDECIMAL_CONVERTER);</span>
<span class="fc" id="L1299">    }</span>

    @Deprecated
    public static RubyConverter getArrayConverter(Class type) {
<span class="nc" id="L1303">        RubyConverter converter = ARRAY_CONVERTERS.get(type);</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">        if (converter == null) {</span>
<span class="nc" id="L1305">            return ARRAY_OBJECT_CONVERTER;</span>
        }
<span class="nc" id="L1307">        return converter;</span>
    }

    /**
     * High-level object conversion utility.
     */
    @Deprecated
    public static IRubyObject ruby_to_java(final IRubyObject recv, IRubyObject object, Block unusedBlock) {
<span class="nc bnc" id="L1315" title="All 2 branches missed.">        if (object.respondsTo(&quot;to_java_object&quot;)) {</span>
<span class="nc" id="L1316">            IRubyObject result = (IRubyObject)object.dataGetStruct();</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">            if (result == null) {</span>
<span class="nc" id="L1318">                result = object.callMethod(recv.getRuntime().getCurrentContext(), &quot;to_java_object&quot;);</span>
            }
<span class="nc bnc" id="L1320" title="All 2 branches missed.">            if (result instanceof JavaObject) {</span>
<span class="nc" id="L1321">                recv.getRuntime().getJavaSupport().getObjectProxyCache().put(((JavaObject) result).getValue(), object);</span>
            }
<span class="nc" id="L1323">            return result;</span>
        }

<span class="nc" id="L1326">        return primitive_to_java(recv, object, unusedBlock);</span>
    }

    @Deprecated
    public static IRubyObject java_to_primitive(IRubyObject recv, IRubyObject object, Block unusedBlock) {
<span class="nc bnc" id="L1331" title="All 2 branches missed.">        if (object instanceof JavaObject) {</span>
<span class="nc" id="L1332">            return JavaUtil.convertJavaToRuby(recv.getRuntime(), ((JavaObject) object).getValue());</span>
        }

<span class="nc" id="L1335">        return object;</span>
    }

    @Deprecated
    public static IRubyObject primitive_to_java(IRubyObject recv, IRubyObject object, Block unusedBlock) {
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        if (object instanceof JavaObject) {</span>
<span class="nc" id="L1341">            return object;</span>
        }
<span class="nc" id="L1343">        Ruby runtime = recv.getRuntime();</span>
        Object javaObject;
<span class="nc bnc" id="L1345" title="All 9 branches missed.">        switch (object.getMetaClass().getClassIndex()) {</span>
        case NIL:
<span class="nc" id="L1347">            javaObject = null;</span>
<span class="nc" id="L1348">            break;</span>
        case FIXNUM:
<span class="nc" id="L1350">            javaObject = Long.valueOf(((RubyFixnum) object).getLongValue());</span>
<span class="nc" id="L1351">            break;</span>
        case BIGNUM:
<span class="nc" id="L1353">            javaObject = ((RubyBignum) object).getValue();</span>
<span class="nc" id="L1354">            break;</span>
        case FLOAT:
<span class="nc" id="L1356">            javaObject = new Double(((RubyFloat) object).getValue());</span>
<span class="nc" id="L1357">            break;</span>
        case STRING:
<span class="nc" id="L1359">            ByteList bytes = ((RubyString) object).getByteList();</span>
<span class="nc" id="L1360">            javaObject = RubyEncoding.decodeUTF8(bytes.getUnsafeBytes(), bytes.begin(), bytes.length());</span>
<span class="nc" id="L1361">            break;</span>
        case TRUE:
<span class="nc" id="L1363">            javaObject = Boolean.TRUE;</span>
<span class="nc" id="L1364">            break;</span>
        case FALSE:
<span class="nc" id="L1366">            javaObject = Boolean.FALSE;</span>
<span class="nc" id="L1367">            break;</span>
        case TIME:
<span class="nc" id="L1369">            javaObject = ((RubyTime) object).getJavaDate();</span>
<span class="nc" id="L1370">            break;</span>
        default:
            // it's not one of the types we convert, so just pass it out as-is without wrapping
<span class="nc" id="L1373">            return object;</span>
        }

        // we've found a Java type to which we've coerced the Ruby value, wrap it
<span class="nc" id="L1377">        return JavaObject.wrap(runtime, javaObject);</span>
    }

    @Deprecated
    public static Object convertArgument(Ruby runtime, Object argument, Class&lt;?&gt; parameterType) {
<span class="nc bnc" id="L1382" title="All 2 branches missed.">        if (argument == null) {</span>
<span class="nc bnc" id="L1383" title="All 2 branches missed.">          if(parameterType.isPrimitive()) {</span>
<span class="nc" id="L1384">            throw runtime.newTypeError(&quot;primitives do not accept null&quot;);</span>
          } else {
<span class="nc" id="L1386">            return null;</span>
          }
        }

<span class="nc bnc" id="L1390" title="All 2 branches missed.">        if (argument instanceof JavaObject) {</span>
<span class="nc" id="L1391">            argument = ((JavaObject) argument).getValue();</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">            if (argument == null) {</span>
<span class="nc" id="L1393">                return null;</span>
            }
        }
<span class="nc" id="L1396">        Class&lt;?&gt; type = primitiveToWrapper(parameterType);</span>

<span class="nc bnc" id="L1398" title="All 2 branches missed.">        if (argument.getClass() == type) return argument;</span>

<span class="nc bnc" id="L1400" title="All 2 branches missed.">        if (type == Void.class) {</span>
<span class="nc" id="L1401">            return null;</span>
        }

<span class="nc bnc" id="L1404" title="All 2 branches missed.">        if (argument instanceof Number) {</span>
<span class="nc" id="L1405">            final Number number = (Number) argument;</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">            if (type == Long.class) {</span>
<span class="nc" id="L1407">                return number.longValue();</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">            } else if (type == Integer.class) {</span>
<span class="nc" id="L1409">                return number.intValue();</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">            } else if (type == Byte.class) {</span>
<span class="nc" id="L1411">                return number.byteValue();</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">            } else if (type == Character.class) {</span>
<span class="nc" id="L1413">                return (char)number.intValue();</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">            } else if (type == Double.class) {</span>
<span class="nc" id="L1415">                return number.doubleValue();</span>
<span class="nc bnc" id="L1416" title="All 2 branches missed.">            } else if (type == Float.class) {</span>
<span class="nc" id="L1417">                return number.floatValue();</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">            } else if (type == Short.class) {</span>
<span class="nc" id="L1419">                return number.shortValue();</span>
            }
        }
<span class="nc bnc" id="L1422" title="All 2 branches missed.">        if (isDuckTypeConvertable(argument.getClass(), parameterType)) {</span>
<span class="nc" id="L1423">            RubyObject rubyObject = (RubyObject) argument;</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">            if (!rubyObject.respondsTo(&quot;java_object&quot;)) {</span>
<span class="nc" id="L1425">                return convertProcToInterface(runtime.getCurrentContext(), rubyObject, parameterType);</span>
            }
        }
<span class="nc" id="L1428">        return argument;</span>
    }

    /**
     * High-level object conversion utility function 'java_to_primitive' is the low-level version
     */
    @Deprecated
    public static IRubyObject java_to_ruby(Ruby runtime, IRubyObject object) {
<span class="nc bnc" id="L1436" title="All 2 branches missed.">        if (object instanceof JavaObject) {</span>
<span class="nc" id="L1437">            return JavaUtil.convertJavaToUsableRubyObject(runtime, ((JavaObject) object).getValue());</span>
        }
<span class="nc" id="L1439">        return object;</span>
    }

    // FIXME: This doesn't actually support anything but String
    @Deprecated
    public static Object coerceStringToType(RubyString string, Class target) {
        try {
<span class="nc" id="L1446">            ByteList bytes = string.getByteList();</span>

            // 1.9 support for encodings
            // TODO: Fix charset use for JRUBY-4553
<span class="nc" id="L1450">            return new String(bytes.getUnsafeBytes(), bytes.begin(), bytes.length(), string.getEncoding().toString());</span>
<span class="nc" id="L1451">        } catch (UnsupportedEncodingException uee) {</span>
<span class="nc" id="L1452">            return string.toString();</span>
        }
    }

    @Deprecated
    public static Object coerceOtherToType(ThreadContext context, IRubyObject arg, Class target) {
<span class="nc bnc" id="L1458" title="All 2 branches missed.">        if (isDuckTypeConvertable(arg.getClass(), target)) {</span>
<span class="nc" id="L1459">            RubyObject rubyObject = (RubyObject) arg;</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">            if (!rubyObject.respondsTo(&quot;java_object&quot;)) {</span>
<span class="nc" id="L1461">                return convertProcToInterface(context, rubyObject, target);</span>
            }
        }

        // it's either as converted as we can make it via above logic or it's
        // not one of the types we convert, so just pass it out as-is without wrapping
<span class="nc" id="L1467">        return arg;</span>
    }

    @Deprecated
    public static Object coerceJavaObjectToType(ThreadContext context, Object javaObject, Class target) {
<span class="nc bnc" id="L1472" title="All 4 branches missed.">        if (javaObject != null &amp;&amp; isDuckTypeConvertable(javaObject.getClass(), target)) {</span>
<span class="nc" id="L1473">            RubyObject rubyObject = (RubyObject) javaObject;</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">            if (!rubyObject.respondsTo(&quot;java_object&quot;)) {</span>
<span class="nc" id="L1475">                return convertProcToInterface(context, rubyObject, target);</span>
            }

            // can't be converted any more, return it
<span class="nc" id="L1479">            return javaObject;</span>
        } else {
<span class="nc" id="L1481">            return javaObject;</span>
        }
    }

    @Deprecated
    public static JavaObject unwrapJavaObject(Ruby runtime, IRubyObject convertee, String errorMessage) {
<span class="nc" id="L1487">        IRubyObject obj = convertee;</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">        if(!(obj instanceof JavaObject)) {</span>
<span class="nc bnc" id="L1489" title="All 4 branches missed.">            if (obj.dataGetStruct() != null &amp;&amp; (obj.dataGetStruct() instanceof JavaObject)) {</span>
<span class="nc" id="L1490">                obj = (JavaObject)obj.dataGetStruct();</span>
            } else {
<span class="nc" id="L1492">                throw runtime.newTypeError(errorMessage);</span>
            }
        }
<span class="nc" id="L1495">        return (JavaObject)obj;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.3.201501050207</span></div></body></html>