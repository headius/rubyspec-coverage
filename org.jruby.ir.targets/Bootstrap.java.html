<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Bootstrap.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rubyspec coverage</a> &gt; <a href="index.source.html" class="el_package">org.jruby.ir.targets</a> &gt; <span class="el_source">Bootstrap.java</span></div><h1>Bootstrap.java</h1><pre class="source lang-java linenums">package org.jruby.ir.targets;

import com.headius.invokebinder.Binder;
import com.headius.invokebinder.Signature;
import com.headius.invokebinder.SmartBinder;
import com.headius.invokebinder.SmartHandle;
import org.jcodings.Encoding;
import org.jcodings.EncodingDB;
import org.jruby.*;
import org.jruby.common.IRubyWarnings;
import org.jruby.compiler.Constantizable;
import org.jruby.internal.runtime.methods.*;
import org.jruby.ir.JIT;
import org.jruby.ir.operands.UndefinedValue;
import org.jruby.ir.runtime.IRRuntimeHelpers;
import org.jruby.parser.StaticScope;
import org.jruby.runtime.Block;
import org.jruby.runtime.Helpers;
import org.jruby.runtime.ThreadContext;
import org.jruby.runtime.builtin.IRubyObject;
import org.jruby.runtime.invokedynamic.InvocationLinker;
import org.jruby.runtime.invokedynamic.VariableSite;
import org.jruby.runtime.ivars.FieldVariableAccessor;
import org.jruby.runtime.ivars.VariableAccessor;
import org.jruby.runtime.opto.OptoFactory;
import org.jruby.util.ByteList;
import org.jruby.util.RegexpOptions;
import org.jruby.util.cli.Options;
import org.jruby.util.log.Logger;
import org.jruby.util.log.LoggerFactory;
import org.objectweb.asm.Handle;
import org.objectweb.asm.Opcodes;

import java.lang.invoke.*;

import static java.lang.invoke.MethodHandles.*;
import static java.lang.invoke.MethodType.methodType;
import static org.jruby.runtime.Helpers.arrayOf;
import static org.jruby.runtime.invokedynamic.InvokeDynamicSupport.*;
import static org.jruby.util.CodegenUtils.p;
import static org.jruby.util.CodegenUtils.sig;

<span class="nc bnc" id="L43" title="All 2 branches missed.">public class Bootstrap {</span>
<span class="nc" id="L44">    private static final Logger LOG = LoggerFactory.getLogger(&quot;Bootstrap&quot;);</span>
<span class="nc" id="L45">    static final Lookup LOOKUP = MethodHandles.lookup();</span>

    public static CallSite string(Lookup lookup, String name, MethodType type, String value, String encodingName) {
        Encoding encoding;
<span class="nc" id="L49">        EncodingDB.Entry entry = EncodingDB.getEncodings().get(encodingName.getBytes());</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (entry == null) entry = EncodingDB.getAliases().get(encodingName.getBytes());</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (entry == null) throw new RuntimeException(&quot;could not find encoding: &quot; + encodingName);</span>
<span class="nc" id="L52">        encoding = entry.getEncoding();</span>
<span class="nc" id="L53">        ByteList byteList = new ByteList(value.getBytes(RubyEncoding.ISO), encoding);</span>
<span class="nc" id="L54">        MutableCallSite site = new MutableCallSite(type);</span>
<span class="nc" id="L55">        Binder binder = Binder</span>
<span class="nc" id="L56">                .from(RubyString.class, ThreadContext.class)</span>
<span class="nc" id="L57">                .insert(0, arrayOf(MutableCallSite.class, ByteList.class), site, byteList);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (name.equals(&quot;frozen&quot;)) {</span>
<span class="nc" id="L59">            site.setTarget(binder.invokeStaticQuiet(lookup, Bootstrap.class, &quot;frozenString&quot;));</span>
        } else {
<span class="nc" id="L61">            site.setTarget(binder.invokeStaticQuiet(lookup, Bootstrap.class, &quot;string&quot;));</span>
        }

<span class="nc" id="L64">        return site;</span>
    }

    public static CallSite bytelist(Lookup lookup, String name, MethodType type, String value, String encodingName) {
        Encoding encoding;
<span class="nc" id="L69">        EncodingDB.Entry entry = EncodingDB.getEncodings().get(encodingName.getBytes());</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (entry == null) entry = EncodingDB.getAliases().get(encodingName.getBytes());</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (entry == null) throw new RuntimeException(&quot;could not find encoding: &quot; + encodingName);</span>
<span class="nc" id="L72">        encoding = entry.getEncoding();</span>
<span class="nc" id="L73">        ByteList byteList = new ByteList(value.getBytes(RubyEncoding.ISO), encoding);</span>
<span class="nc" id="L74">        return new ConstantCallSite(constant(ByteList.class, byteList));</span>
    }

    public static CallSite array(Lookup lookup, String name, MethodType type) {
<span class="nc" id="L78">        MethodHandle handle = Binder</span>
<span class="nc" id="L79">                .from(type)</span>
<span class="nc" id="L80">                .collect(1, IRubyObject[].class)</span>
<span class="nc" id="L81">                .invokeStaticQuiet(LOOKUP, Bootstrap.class, &quot;array&quot;);</span>
<span class="nc" id="L82">        CallSite site = new ConstantCallSite(handle);</span>
<span class="nc" id="L83">        return site;</span>
    }

    public static CallSite hash(Lookup lookup, String name, MethodType type) {
<span class="nc" id="L87">        MethodHandle handle = Binder</span>
<span class="nc" id="L88">                .from(lookup, type)</span>
<span class="nc" id="L89">                .collect(1, IRubyObject[].class)</span>
<span class="nc" id="L90">                .invokeStaticQuiet(LOOKUP, Bootstrap.class, &quot;hash&quot;);</span>
<span class="nc" id="L91">        CallSite site = new ConstantCallSite(handle);</span>
<span class="nc" id="L92">        return site;</span>
    }

    public static CallSite kwargsHash(Lookup lookup, String name, MethodType type) {
<span class="nc" id="L96">        MethodHandle handle = Binder</span>
<span class="nc" id="L97">                .from(lookup, type)</span>
<span class="nc" id="L98">                .collect(2, IRubyObject[].class)</span>
<span class="nc" id="L99">                .invokeStaticQuiet(LOOKUP, Bootstrap.class, &quot;kwargsHash&quot;);</span>
<span class="nc" id="L100">        CallSite site = new ConstantCallSite(handle);</span>
<span class="nc" id="L101">        return site;</span>
    }

    public static CallSite ivar(Lookup lookup, String name, MethodType type) throws Throwable {
<span class="nc" id="L105">        String[] names = name.split(&quot;:&quot;);</span>
<span class="nc" id="L106">        String operation = names[0];</span>
<span class="nc" id="L107">        String varName = names[1];</span>
<span class="nc" id="L108">        VariableSite site = new VariableSite(type, varName, &quot;noname&quot;, 0);</span>
        MethodHandle handle;

<span class="nc" id="L111">        handle = lookup.findStatic(Bootstrap.class, operation, type.insertParameterTypes(0, VariableSite.class));</span>

<span class="nc" id="L113">        handle = handle.bindTo(site);</span>
<span class="nc" id="L114">        site.setTarget(handle.asType(site.type()));</span>

<span class="nc" id="L116">        return site;</span>
    }

    public static CallSite searchConst(Lookup lookup, String name, MethodType type, int noPrivateConsts) {
<span class="nc" id="L120">        MutableCallSite site = new MutableCallSite(type);</span>
<span class="nc" id="L121">        String[] bits = name.split(&quot;:&quot;);</span>
<span class="nc" id="L122">        String constName = bits[1];</span>

<span class="nc" id="L124">        MethodHandle handle = Binder</span>
<span class="nc" id="L125">                .from(lookup, type)</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                .append(site, constName.intern())</span>
<span class="nc" id="L127">                .append(noPrivateConsts == 0 ? false : true)</span>
<span class="nc" id="L128">                .invokeStaticQuiet(LOOKUP, Bootstrap.class, bits[0]);</span>

<span class="nc" id="L130">        site.setTarget(handle);</span>

<span class="nc" id="L132">        return site;</span>
    }

    public static Handle string() {
<span class="nc" id="L136">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;string&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class, String.class, String.class));</span>
    }

    public static Handle bytelist() {
<span class="nc" id="L140">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;bytelist&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class, String.class, String.class));</span>
    }

    public static Handle array() {
<span class="nc" id="L144">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;array&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class));</span>
    }

    public static Handle hash() {
<span class="nc" id="L148">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;hash&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class));</span>
    }

    public static Handle kwargsHash() {
<span class="nc" id="L152">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;kwargsHash&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class));</span>
    }

    public static Handle invokeSuper() {
<span class="nc" id="L156">        return SuperInvokeSite.BOOTSTRAP;</span>
    }

    public static Handle ivar() {
<span class="nc" id="L160">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;ivar&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class));</span>
    }

    public static Handle searchConst() {
<span class="nc" id="L164">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;searchConst&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class, int.class));</span>
    }

    public static RubyString string(MutableCallSite site, ByteList value, ThreadContext context) throws Throwable {
<span class="nc" id="L168">        MethodHandle handle = SmartBinder</span>
<span class="nc" id="L169">                .from(STRING_SIGNATURE)</span>
<span class="nc" id="L170">                .invoke(NEW_STRING_SHARED_HANDLE.apply(&quot;byteList&quot;, value))</span>
<span class="nc" id="L171">                .handle();</span>

<span class="nc" id="L173">        site.setTarget(handle);</span>

<span class="nc" id="L175">        return RubyString.newStringShared(context.runtime, value);</span>
    }

    public static RubyString frozenString(MutableCallSite site, ByteList value, ThreadContext context) throws Throwable {
<span class="nc" id="L179">        RubyString frozen = context.runtime.freezeAndDedupString(RubyString.newStringShared(context.runtime, value));</span>
<span class="nc" id="L180">        MethodHandle handle = Binder.from(RubyString.class, ThreadContext.class)</span>
<span class="nc" id="L181">                .dropAll()</span>
<span class="nc" id="L182">                .constant(frozen);</span>

<span class="nc" id="L184">        site.setTarget(handle);</span>

<span class="nc" id="L186">        return frozen;</span>
    }

<span class="nc" id="L189">    private static final Signature STRING_SIGNATURE = Signature.from(RubyString.class, arrayOf(ThreadContext.class), &quot;context&quot;);</span>
<span class="nc" id="L190">    private static final Signature NEW_STRING_SHARED_SIGNATURE = Signature.from(RubyString.class, arrayOf(ThreadContext.class, ByteList.class), &quot;context&quot;, &quot;byteList&quot;);</span>

<span class="nc" id="L192">    private static final SmartHandle NEW_STRING_SHARED_HANDLE =</span>
<span class="nc" id="L193">            SmartBinder.from(NEW_STRING_SHARED_SIGNATURE)</span>
<span class="nc" id="L194">                    .invokeStaticQuiet(MethodHandles.lookup(), Bootstrap.class, &quot;newStringShared&quot;);</span>
    @JIT
    private static RubyString newStringShared(ThreadContext context, ByteList byteList) {
<span class="nc" id="L197">        return RubyString.newStringShared(context.runtime, byteList);</span>
    }

    public static IRubyObject array(ThreadContext context, IRubyObject[] elts) {
<span class="nc" id="L201">        return RubyArray.newArrayNoCopy(context.runtime, elts);</span>
    }

    public static Handle contextValue() {
<span class="nc" id="L205">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;contextValue&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class));</span>
    }

    public static Handle contextValueString() {
<span class="nc" id="L209">        return new Handle(Opcodes.H_INVOKESTATIC, p(Bootstrap.class), &quot;contextValueString&quot;, sig(CallSite.class, Lookup.class, String.class, MethodType.class, String.class));</span>
    }

    public static CallSite contextValue(Lookup lookup, String name, MethodType type) {
<span class="nc" id="L213">        MutableCallSite site = new MutableCallSite(type);</span>
<span class="nc" id="L214">        site.setTarget(Binder.from(type).append(site).invokeStaticQuiet(lookup, Bootstrap.class, name));</span>
<span class="nc" id="L215">        return site;</span>
    }

    public static CallSite contextValueString(Lookup lookup, String name, MethodType type, String str) {
<span class="nc" id="L219">        MutableCallSite site = new MutableCallSite(type);</span>
<span class="nc" id="L220">        site.setTarget(Binder.from(type).append(site, str).invokeStaticQuiet(lookup, Bootstrap.class, name));</span>
<span class="nc" id="L221">        return site;</span>
    }

    public static IRubyObject nil(ThreadContext context, MutableCallSite site) {
<span class="nc" id="L225">        MethodHandle constant = (MethodHandle)((RubyNil)context.nil).constant();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (constant == null) constant = (MethodHandle)OptoFactory.newConstantWrapper(IRubyObject.class, context.nil);</span>

<span class="nc" id="L228">        site.setTarget(constant);</span>

<span class="nc" id="L230">        return context.nil;</span>
    }

    public static IRubyObject True(ThreadContext context, MutableCallSite site) {
<span class="nc" id="L234">        MethodHandle constant = (MethodHandle)context.runtime.getTrue().constant();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (constant == null) constant = (MethodHandle)OptoFactory.newConstantWrapper(IRubyObject.class, context.runtime.getTrue());</span>

<span class="nc" id="L237">        site.setTarget(constant);</span>

<span class="nc" id="L239">        return context.runtime.getTrue();</span>
    }

    public static IRubyObject False(ThreadContext context, MutableCallSite site) {
<span class="nc" id="L243">        MethodHandle constant = (MethodHandle)context.runtime.getFalse().constant();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (constant == null) constant = (MethodHandle)OptoFactory.newConstantWrapper(IRubyObject.class, context.runtime.getFalse());</span>

<span class="nc" id="L246">        site.setTarget(constant);</span>

<span class="nc" id="L248">        return context.runtime.getFalse();</span>
    }

    public static Ruby runtime(ThreadContext context, MutableCallSite site) {
<span class="nc" id="L252">        MethodHandle constant = (MethodHandle)context.runtime.constant();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (constant == null) constant = (MethodHandle)OptoFactory.newConstantWrapper(Ruby.class, context.runtime);</span>

<span class="nc" id="L255">        site.setTarget(constant);</span>

<span class="nc" id="L257">        return context.runtime;</span>
    }

    public static RubyEncoding encoding(ThreadContext context, MutableCallSite site, String name) {
<span class="nc" id="L261">        RubyEncoding rubyEncoding = IRRuntimeHelpers.retrieveEncoding(context, name);</span>

<span class="nc" id="L263">        MethodHandle constant = (MethodHandle)rubyEncoding.constant();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (constant == null) constant = (MethodHandle)OptoFactory.newConstantWrapper(RubyEncoding.class, rubyEncoding);</span>

<span class="nc" id="L266">        site.setTarget(constant);</span>

<span class="nc" id="L268">        return rubyEncoding;</span>
    }

    public static IRubyObject hash(ThreadContext context, IRubyObject[] pairs) {
<span class="nc" id="L272">        Ruby runtime = context.runtime;</span>
<span class="nc" id="L273">        RubyHash hash = RubyHash.newHash(runtime);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        for (int i = 0; i &lt; pairs.length;) {</span>
<span class="nc" id="L275">            hash.fastASetCheckString(runtime, pairs[i++], pairs[i++]);</span>
        }
<span class="nc" id="L277">        return hash;</span>
    }

    public static IRubyObject kwargsHash(ThreadContext context, RubyHash hash, IRubyObject[] pairs) {
<span class="nc" id="L281">        return IRRuntimeHelpers.dupKwargsHashAndPopulateFromArray(context, hash, pairs);</span>
    }

    static MethodHandle buildGenericHandle(InvokeSite site, DynamicMethod method, RubyClass dispatchClass) {
        SmartBinder binder;

<span class="nc" id="L287">        binder = SmartBinder.from(site.signature)</span>
<span class="nc" id="L288">                .permute(&quot;context&quot;, &quot;self&quot;, &quot;arg.*&quot;, &quot;block&quot;)</span>
<span class="nc" id="L289">                .insert(2, new String[]{&quot;rubyClass&quot;, &quot;name&quot;}, new Class[]{RubyModule.class, String.class}, dispatchClass, site.name())</span>
<span class="nc" id="L290">                .insert(0, &quot;method&quot;, DynamicMethod.class, method);</span>

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (site.arity &gt; 3) {</span>
<span class="nc" id="L293">            binder = binder.collect(&quot;args&quot;, &quot;arg.*&quot;);</span>
        }

<span class="nc" id="L296">        return binder.invokeVirtualQuiet(LOOKUP, &quot;call&quot;).handle();</span>
    }

    static MethodHandle buildJittedHandle(InvokeSite site, DynamicMethod method, boolean blockGiven) {
<span class="nc" id="L300">        MethodHandle mh = null;</span>
        SmartBinder binder;
<span class="nc" id="L302">        CompiledIRMethod compiledIRMethod = null;</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">        if (method instanceof CompiledIRMethod) {</span>
<span class="nc" id="L305">            compiledIRMethod = (CompiledIRMethod)method;</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        } else if (method instanceof InterpretedIRMethod) {</span>
<span class="nc" id="L307">            DynamicMethod actualMethod = ((InterpretedIRMethod)method).getActualMethod();</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (actualMethod instanceof CompiledIRMethod) {</span>
<span class="nc" id="L309">                compiledIRMethod = (CompiledIRMethod)actualMethod;</span>
            }
        }

<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (compiledIRMethod != null) {</span>
            // attempt IR direct binding
            // TODO: this will have to expand when we start specializing arities

<span class="nc" id="L317">            binder = SmartBinder.from(site.signature)</span>
<span class="nc" id="L318">                    .permute(&quot;context&quot;, &quot;self&quot;, &quot;arg.*&quot;, &quot;block&quot;);</span>

<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (site.arity == -1) {</span>
                // already [], nothing to do
<span class="nc" id="L322">                mh = (MethodHandle)compiledIRMethod.getHandle();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">            } else if (site.arity == 0) {</span>
                MethodHandle specific;
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if ((specific = compiledIRMethod.getHandleFor(site.arity)) != null) {</span>
<span class="nc" id="L326">                    mh = specific;</span>
                } else {
<span class="nc" id="L328">                    mh = (MethodHandle)compiledIRMethod.getHandle();</span>
<span class="nc" id="L329">                    binder = binder.insert(2, &quot;args&quot;, IRubyObject.NULL_ARRAY);</span>
                }
<span class="nc" id="L331">            } else {</span>
                MethodHandle specific;
<span class="nc bnc" id="L333" title="All 2 branches missed.">                if ((specific = compiledIRMethod.getHandleFor(site.arity)) != null) {</span>
<span class="nc" id="L334">                    mh = specific;</span>
                } else {
<span class="nc" id="L336">                    mh = (MethodHandle) compiledIRMethod.getHandle();</span>
<span class="nc" id="L337">                    binder = binder.collect(&quot;args&quot;, &quot;arg.*&quot;);</span>
                }
            }

<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (!blockGiven) {</span>
<span class="nc" id="L342">                binder = binder.append(&quot;block&quot;, Block.class, Block.NULL_BLOCK);</span>
            }

<span class="nc" id="L345">            binder = binder</span>
<span class="nc" id="L346">                    .insert(1, &quot;scope&quot;, StaticScope.class, compiledIRMethod.getStaticScope())</span>
<span class="nc" id="L347">                    .append(&quot;class&quot;, RubyModule.class, compiledIRMethod.getImplementationClass());</span>

<span class="nc" id="L349">            mh = binder.invoke(mh).handle();</span>
        }

<span class="nc" id="L352">        return mh;</span>
    }

    static MethodHandle buildNativeHandle(InvokeSite site, DynamicMethod method, boolean blockGiven) {
<span class="nc" id="L356">        MethodHandle mh = null;</span>
<span class="nc" id="L357">        SmartBinder binder = null;</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (method.getNativeCall() != null) {</span>

<span class="nc" id="L361">            int nativeArgCount = getNativeArgCount(method, method.getNativeCall());</span>

<span class="nc" id="L363">            DynamicMethod.NativeCall nc = method.getNativeCall();</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (nc.isJava()) {</span>
                // not supported yet, use DynamicMethod.call
            } else {
<span class="nc bnc" id="L368" title="All 2 branches missed.">                if (nativeArgCount &gt;= 0) { // native methods only support arity 3</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                    if (nativeArgCount == site.arity) {</span>
                        // nothing to do
<span class="nc" id="L371">                        binder = SmartBinder.from(lookup(), site.signature);</span>
                    } else {
                        // arity mismatch...leave null and use DynamicMethod.call below
                    }
                } else {
                    // varargs
<span class="nc bnc" id="L377" title="All 2 branches missed.">                    if (site.arity == -1) {</span>
                        // ok, already passing []
<span class="nc" id="L379">                        binder = SmartBinder.from(lookup(), site.signature);</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">                    } else if (site.arity == 0) {</span>
                        // no args, insert dummy
<span class="nc" id="L382">                        binder = SmartBinder.from(lookup(), site.signature)</span>
<span class="nc" id="L383">                                .insert(2, &quot;args&quot;, IRubyObject.NULL_ARRAY);</span>
                    } else {
                        // 1 or more args, collect into []
<span class="nc" id="L386">                        binder = SmartBinder.from(lookup(), site.signature)</span>
<span class="nc" id="L387">                                .collect(&quot;args&quot;, &quot;arg.*&quot;);</span>
                    }
                }

<span class="nc bnc" id="L391" title="All 2 branches missed.">                if (binder != null) {</span>

                    // clean up non-arguments, ordering, types
<span class="nc bnc" id="L394" title="All 2 branches missed.">                    if (!nc.hasContext()) {</span>
<span class="nc" id="L395">                        binder = binder.drop(&quot;context&quot;);</span>
                    }

<span class="nc bnc" id="L398" title="All 4 branches missed.">                    if (nc.hasBlock() &amp;&amp; !blockGiven) {</span>
<span class="nc" id="L399">                        binder = binder.append(&quot;block&quot;, Block.NULL_BLOCK);</span>
<span class="nc bnc" id="L400" title="All 4 branches missed.">                    } else if (!nc.hasBlock() &amp;&amp; blockGiven) {</span>
<span class="nc" id="L401">                        binder = binder.drop(&quot;block&quot;);</span>
                    }

<span class="nc bnc" id="L404" title="All 2 branches missed.">                    if (nc.isStatic()) {</span>
<span class="nc" id="L405">                        mh = binder</span>
<span class="nc" id="L406">                                .permute(&quot;context&quot;, &quot;self&quot;, &quot;arg.*&quot;, &quot;block&quot;) // filter caller</span>
<span class="nc" id="L407">                                .cast(nc.getNativeReturn(), nc.getNativeSignature())</span>
<span class="nc" id="L408">                                .invokeStaticQuiet(LOOKUP, nc.getNativeTarget(), nc.getNativeName())</span>
<span class="nc" id="L409">                                .handle();</span>
                    } else {
<span class="nc" id="L411">                        mh = binder</span>
<span class="nc" id="L412">                                .permute(&quot;self&quot;, &quot;context&quot;, &quot;arg.*&quot;, &quot;block&quot;) // filter caller, move self</span>
<span class="nc" id="L413">                                .castArg(&quot;self&quot;, nc.getNativeTarget())</span>
<span class="nc" id="L414">                                .castVirtual(nc.getNativeReturn(), nc.getNativeTarget(), nc.getNativeSignature())</span>
<span class="nc" id="L415">                                .invokeVirtualQuiet(LOOKUP, nc.getNativeName())</span>
<span class="nc" id="L416">                                .handle();</span>
                    }
                }
            }
        }

<span class="nc" id="L422">        return mh;</span>
    }

    public static int getNativeArgCount(DynamicMethod method, DynamicMethod.NativeCall nativeCall) {
        // if non-Java, must:
        // * exactly match arities or both are [] boxed
        // * 3 or fewer arguments
<span class="nc" id="L429">        return getArgCount(nativeCall.getNativeSignature(), nativeCall.isStatic());</span>
    }

    private static int getArgCount(Class[] args, boolean isStatic) {
<span class="nc" id="L433">        int length = args.length;</span>
<span class="nc" id="L434">        boolean hasContext = false;</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (isStatic) {</span>
<span class="nc bnc" id="L436" title="All 4 branches missed.">            if (args.length &gt; 1 &amp;&amp; args[0] == ThreadContext.class) {</span>
<span class="nc" id="L437">                length--;</span>
<span class="nc" id="L438">                hasContext = true;</span>
            }

            // remove self object
<span class="nc bnc" id="L442" title="All 4 branches missed.">            assert args.length &gt;= 1;</span>
<span class="nc" id="L443">            length--;</span>

<span class="nc bnc" id="L445" title="All 4 branches missed.">            if (args.length &gt; 1 &amp;&amp; args[args.length - 1] == Block.class) {</span>
<span class="nc" id="L446">                length--;</span>
            }

<span class="nc bnc" id="L449" title="All 2 branches missed.">            if (length == 1) {</span>
<span class="nc bnc" id="L450" title="All 4 branches missed.">                if (hasContext &amp;&amp; args[2] == IRubyObject[].class) {</span>
<span class="nc" id="L451">                    length = -1;</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                } else if (args[1] == IRubyObject[].class) {</span>
<span class="nc" id="L453">                    length = -1;</span>
                }
            }
        } else {
<span class="nc bnc" id="L457" title="All 4 branches missed.">            if (args.length &gt; 0 &amp;&amp; args[0] == ThreadContext.class) {</span>
<span class="nc" id="L458">                length--;</span>
<span class="nc" id="L459">                hasContext = true;</span>
            }

<span class="nc bnc" id="L462" title="All 4 branches missed.">            if (args.length &gt; 0 &amp;&amp; args[args.length - 1] == Block.class) {</span>
<span class="nc" id="L463">                length--;</span>
            }

<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (length == 1) {</span>
<span class="nc bnc" id="L467" title="All 4 branches missed.">                if (hasContext &amp;&amp; args[1] == IRubyObject[].class) {</span>
<span class="nc" id="L468">                    length = -1;</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                } else if (args[0] == IRubyObject[].class) {</span>
<span class="nc" id="L470">                    length = -1;</span>
                }
            }
        }
<span class="nc" id="L474">        return length;</span>
    }

    public static IRubyObject ivarGet(VariableSite site, IRubyObject self) throws Throwable {
<span class="nc" id="L478">        RubyClass realClass = self.getMetaClass().getRealClass();</span>
<span class="nc" id="L479">        VariableAccessor accessor = realClass.getVariableAccessorForRead(site.name());</span>

        // produce nil if the variable has not been initialize
<span class="nc" id="L482">        MethodHandle nullToNil = findStatic(Helpers.class, &quot;nullToNil&quot;, methodType(IRubyObject.class, IRubyObject.class, IRubyObject.class));</span>
<span class="nc" id="L483">        nullToNil = insertArguments(nullToNil, 1, self.getRuntime().getNil());</span>
<span class="nc" id="L484">        nullToNil = explicitCastArguments(nullToNil, methodType(IRubyObject.class, Object.class));</span>

        // get variable value and filter with nullToNil
        MethodHandle getValue;
<span class="nc" id="L488">        boolean direct = false;</span>

<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (accessor instanceof FieldVariableAccessor) {</span>
<span class="nc" id="L491">            direct = true;</span>
<span class="nc" id="L492">            int offset = ((FieldVariableAccessor)accessor).getOffset();</span>
<span class="nc" id="L493">            Class cls = REIFIED_OBJECT_CLASSES[offset];</span>
<span class="nc" id="L494">            getValue = lookup().findGetter(cls, &quot;var&quot; + offset, Object.class);</span>
<span class="nc" id="L495">            getValue = explicitCastArguments(getValue, methodType(Object.class, IRubyObject.class));</span>
<span class="nc" id="L496">        } else {</span>
<span class="nc" id="L497">            getValue = findStatic(VariableAccessor.class, &quot;getVariable&quot;, methodType(Object.class, RubyBasicObject.class, int.class));</span>
<span class="nc" id="L498">            getValue = explicitCastArguments(getValue, methodType(Object.class, IRubyObject.class, int.class));</span>
<span class="nc" id="L499">            getValue = insertArguments(getValue, 1, accessor.getIndex());</span>
        }

<span class="nc" id="L502">        getValue = filterReturnValue(getValue, nullToNil);</span>

        // prepare fallback
<span class="nc" id="L505">        MethodHandle fallback = null;</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (site.chainCount() + 1 &gt; Options.INVOKEDYNAMIC_MAXPOLY.load()) {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (Options.INVOKEDYNAMIC_LOG_BINDING.load()) LOG.info(site.name() + &quot;\tqet on type &quot; + self.getMetaClass().id + &quot; failed (polymorphic)&quot; + extractSourceInfo(site));</span>
<span class="nc" id="L508">            fallback = findStatic(Bootstrap.class, &quot;ivarGetFail&quot;, methodType(IRubyObject.class, VariableSite.class, IRubyObject.class));</span>
<span class="nc" id="L509">            fallback = fallback.bindTo(site);</span>
<span class="nc" id="L510">            site.setTarget(fallback);</span>
<span class="nc" id="L511">            return (IRubyObject)fallback.invokeWithArguments(self);</span>
        } else {
<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (Options.INVOKEDYNAMIC_LOG_BINDING.load()) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                if (direct) {</span>
<span class="nc" id="L515">                    LOG.info(site.name() + &quot;\tget field on type &quot; + self.getMetaClass().id + &quot; added to PIC&quot; + extractSourceInfo(site));</span>
                } else {
<span class="nc" id="L517">                    LOG.info(site.name() + &quot;\tget on type &quot; + self.getMetaClass().id + &quot; added to PIC&quot; + extractSourceInfo(site));</span>
                }
            }
<span class="nc" id="L520">            fallback = site.getTarget();</span>
<span class="nc" id="L521">            site.incrementChainCount();</span>
        }

        // prepare test
<span class="nc" id="L525">        MethodHandle test = findStatic(InvocationLinker.class, &quot;testRealClass&quot;, methodType(boolean.class, int.class, IRubyObject.class));</span>
<span class="nc" id="L526">        test = insertArguments(test, 0, accessor.getClassId());</span>

<span class="nc" id="L528">        getValue = guardWithTest(test, getValue, fallback);</span>

<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (Options.INVOKEDYNAMIC_LOG_BINDING.load()) LOG.info(site.name() + &quot;\tget on class &quot; + self.getMetaClass().id + &quot; bound directly&quot; + extractSourceInfo(site));</span>
<span class="nc" id="L531">        site.setTarget(getValue);</span>

<span class="nc" id="L533">        return (IRubyObject)getValue.invokeExact(self);</span>
    }

    public static IRubyObject ivarGetFail(VariableSite site, IRubyObject self) throws Throwable {
<span class="nc" id="L537">        return site.getVariable(self);</span>
    }

    public static void ivarSet(VariableSite site, IRubyObject self, IRubyObject value) throws Throwable {
<span class="nc" id="L541">        RubyClass realClass = self.getMetaClass().getRealClass();</span>
<span class="nc" id="L542">        VariableAccessor accessor = realClass.getVariableAccessorForWrite(site.name());</span>

        // set variable value and fold by returning value
        MethodHandle setValue;
<span class="nc" id="L546">        boolean direct = false;</span>

<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (accessor instanceof FieldVariableAccessor) {</span>
<span class="nc" id="L549">            direct = true;</span>
<span class="nc" id="L550">            int offset = ((FieldVariableAccessor)accessor).getOffset();</span>
<span class="nc" id="L551">            Class cls = REIFIED_OBJECT_CLASSES[offset];</span>
<span class="nc" id="L552">            setValue = findStatic(cls, &quot;setVariableChecked&quot;, methodType(void.class, cls, Object.class));</span>
<span class="nc" id="L553">            setValue = explicitCastArguments(setValue, methodType(void.class, IRubyObject.class, IRubyObject.class));</span>
<span class="nc" id="L554">        } else {</span>
<span class="nc" id="L555">            setValue = findStatic(accessor.getClass(), &quot;setVariableChecked&quot;, methodType(void.class, RubyBasicObject.class, RubyClass.class, int.class, Object.class));</span>
<span class="nc" id="L556">            setValue = explicitCastArguments(setValue, methodType(void.class, IRubyObject.class, RubyClass.class, int.class, IRubyObject.class));</span>
<span class="nc" id="L557">            setValue = insertArguments(setValue, 1, realClass, accessor.getIndex());</span>
        }

        // prepare fallback
<span class="nc" id="L561">        MethodHandle fallback = null;</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">        if (site.chainCount() + 1 &gt; Options.INVOKEDYNAMIC_MAXPOLY.load()) {</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">            if (Options.INVOKEDYNAMIC_LOG_BINDING.load()) LOG.info(site.name() + &quot;\tset on type &quot; + self.getMetaClass().id + &quot; failed (polymorphic)&quot; + extractSourceInfo(site));</span>
<span class="nc" id="L564">            fallback = findStatic(Bootstrap.class, &quot;ivarSetFail&quot;, methodType(void.class, VariableSite.class, IRubyObject.class, IRubyObject.class));</span>
<span class="nc" id="L565">            fallback = fallback.bindTo(site);</span>
<span class="nc" id="L566">            site.setTarget(fallback);</span>
<span class="nc" id="L567">            fallback.invokeExact(self, value);</span>
        } else {
<span class="nc bnc" id="L569" title="All 2 branches missed.">            if (Options.INVOKEDYNAMIC_LOG_BINDING.load()) {</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                if (direct) {</span>
<span class="nc" id="L571">                    LOG.info(site.name() + &quot;\tset field on type &quot; + self.getMetaClass().id + &quot; added to PIC&quot; + extractSourceInfo(site));</span>
                } else {
<span class="nc" id="L573">                    LOG.info(site.name() + &quot;\tset on type &quot; + self.getMetaClass().id + &quot; added to PIC&quot; + extractSourceInfo(site));</span>
                }
            }
<span class="nc" id="L576">            fallback = site.getTarget();</span>
<span class="nc" id="L577">            site.incrementChainCount();</span>
        }

        // prepare test
<span class="nc" id="L581">        MethodHandle test = findStatic(InvocationLinker.class, &quot;testRealClass&quot;, methodType(boolean.class, int.class, IRubyObject.class));</span>
<span class="nc" id="L582">        test = insertArguments(test, 0, accessor.getClassId());</span>
<span class="nc" id="L583">        test = dropArguments(test, 1, IRubyObject.class);</span>

<span class="nc" id="L585">        setValue = guardWithTest(test, setValue, fallback);</span>

<span class="nc bnc" id="L587" title="All 2 branches missed.">        if (Options.INVOKEDYNAMIC_LOG_BINDING.load()) LOG.info(site.name() + &quot;\tset on class &quot; + self.getMetaClass().id + &quot; bound directly&quot; + extractSourceInfo(site));</span>
<span class="nc" id="L588">        site.setTarget(setValue);</span>

<span class="nc" id="L590">        setValue.invokeExact(self, value);</span>
<span class="nc" id="L591">    }</span>

    public static void ivarSetFail(VariableSite site, IRubyObject self, IRubyObject value) throws Throwable {
<span class="nc" id="L594">        site.setVariable(self, value);</span>
<span class="nc" id="L595">    }</span>

    private static MethodHandle findStatic(Class target, String name, MethodType type) {
<span class="nc" id="L598">        return findStatic(lookup(), target, name, type);</span>
    }

    private static MethodHandle findStatic(Lookup lookup, Class target, String name, MethodType type) {
        try {
<span class="nc" id="L603">            return lookup.findStatic(target, name, type);</span>
<span class="nc" id="L604">        } catch (Exception e) {</span>
<span class="nc" id="L605">            throw new RuntimeException(e);</span>
        }
    }

    public static boolean testType(RubyClass original, IRubyObject self) {
        // naive test
<span class="nc bnc" id="L611" title="All 2 branches missed.">        return ((RubyBasicObject)self).getMetaClass() == original;</span>
    }

    ///////////////////////////////////////////////////////////////////////////
    // constant lookup

    public static IRubyObject searchConst(ThreadContext context, StaticScope staticScope, MutableCallSite site, String constName, boolean noPrivateConsts) throws Throwable {

        // Lexical lookup
<span class="nc" id="L620">        Ruby runtime = context.getRuntime();</span>
<span class="nc" id="L621">        RubyModule object = runtime.getObject();</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        IRubyObject constant = (staticScope == null) ? object.getConstant(constName) : staticScope.getConstantInner(constName);</span>

        // Inheritance lookup
<span class="nc" id="L625">        RubyModule module = null;</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (constant == null) {</span>
            // SSS FIXME: Is this null check case correct?
<span class="nc bnc" id="L628" title="All 2 branches missed.">            module = staticScope == null ? object : staticScope.getModule();</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">            constant = noPrivateConsts ? module.getConstantFromNoConstMissing(constName, false) : module.getConstantNoConstMissing(constName);</span>
        }

        // Call const_missing or cache
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (constant == null) {</span>
<span class="nc" id="L634">            return module.callMethod(context, &quot;const_missing&quot;, context.runtime.fastNewSymbol(constName));</span>
        }

<span class="nc" id="L637">        SwitchPoint switchPoint = (SwitchPoint)runtime.getConstantInvalidator(constName).getData();</span>

        // bind constant until invalidated
<span class="nc" id="L640">        MethodHandle target = Binder.from(site.type())</span>
<span class="nc" id="L641">                .drop(0, 2)</span>
<span class="nc" id="L642">                .constant(constant);</span>
<span class="nc" id="L643">        MethodHandle fallback = Binder.from(site.type())</span>
<span class="nc" id="L644">                .append(site, constName)</span>
<span class="nc" id="L645">                .append(noPrivateConsts)</span>
<span class="nc" id="L646">                .invokeStatic(LOOKUP, Bootstrap.class, &quot;searchConst&quot;);</span>

<span class="nc" id="L648">        site.setTarget(switchPoint.guardWithTest(target, fallback));</span>

<span class="nc" id="L650">        return constant;</span>
    }

    public static IRubyObject inheritanceSearchConst(ThreadContext context, IRubyObject cmVal, MutableCallSite site, String constName, boolean noPrivateConsts) throws Throwable {
<span class="nc" id="L654">        Ruby runtime = context.runtime;</span>
        RubyModule module;

<span class="nc bnc" id="L657" title="All 2 branches missed.">        if (cmVal instanceof RubyModule) {</span>
<span class="nc" id="L658">            module = (RubyModule) cmVal;</span>
        } else {
<span class="nc" id="L660">            throw runtime.newTypeError(cmVal + &quot; is not a type/class&quot;);</span>
        }

<span class="nc bnc" id="L663" title="All 2 branches missed.">        IRubyObject constant = noPrivateConsts ? module.getConstantFromNoConstMissing(constName, false) : module.getConstantNoConstMissing(constName);</span>

<span class="nc bnc" id="L665" title="All 2 branches missed.">        if (constant == null) {</span>
<span class="nc" id="L666">            constant = UndefinedValue.UNDEFINED;</span>
        }

<span class="nc" id="L669">        SwitchPoint switchPoint = (SwitchPoint)runtime.getConstantInvalidator(constName).getData();</span>

        // bind constant until invalidated
<span class="nc" id="L672">        MethodHandle target = Binder.from(site.type())</span>
<span class="nc" id="L673">                .drop(0, 2)</span>
<span class="nc" id="L674">                .constant(constant);</span>
<span class="nc" id="L675">        MethodHandle fallback = Binder.from(site.type())</span>
<span class="nc" id="L676">                .append(site, constName)</span>
<span class="nc" id="L677">                .append(noPrivateConsts)</span>
<span class="nc" id="L678">                .invokeStatic(LOOKUP, Bootstrap.class, &quot;inheritanceSearchConst&quot;);</span>

        // test that module is same as before
<span class="nc" id="L681">        MethodHandle test = Binder.from(site.type().changeReturnType(boolean.class))</span>
<span class="nc" id="L682">                .drop(0, 1)</span>
<span class="nc" id="L683">                .insert(1, module.id)</span>
<span class="nc" id="L684">                .invokeStaticQuiet(LOOKUP, Bootstrap.class, &quot;testArg0ModuleMatch&quot;);</span>
<span class="nc" id="L685">        target = guardWithTest(test, target, fallback);</span>
<span class="nc" id="L686">        site.setTarget(switchPoint.guardWithTest(target, fallback));</span>

<span class="nc" id="L688">        return constant;</span>
    }

    public static IRubyObject lexicalSearchConst(ThreadContext context, StaticScope scope, MutableCallSite site, String constName, boolean noPrivateConsts) throws Throwable {
<span class="nc" id="L692">        Ruby runtime = context.runtime;</span>

<span class="nc" id="L694">        IRubyObject constant = scope.getConstantInner(constName);</span>

<span class="nc bnc" id="L696" title="All 2 branches missed.">        if (constant == null) {</span>
<span class="nc" id="L697">            constant = UndefinedValue.UNDEFINED;</span>
        }

<span class="nc" id="L700">        SwitchPoint switchPoint = (SwitchPoint)runtime.getConstantInvalidator(constName).getData();</span>

        // bind constant until invalidated
<span class="nc" id="L703">        MethodHandle target = Binder.from(site.type())</span>
<span class="nc" id="L704">                .drop(0, 2)</span>
<span class="nc" id="L705">                .constant(constant);</span>
<span class="nc" id="L706">        MethodHandle fallback = Binder.from(site.type())</span>
<span class="nc" id="L707">                .append(site, constName)</span>
<span class="nc" id="L708">                .append(noPrivateConsts)</span>
<span class="nc" id="L709">                .invokeStatic(LOOKUP, Bootstrap.class, &quot;lexicalSearchConst&quot;);</span>

<span class="nc" id="L711">        site.setTarget(switchPoint.guardWithTest(target, fallback));</span>

<span class="nc" id="L713">        return constant;</span>
    }

    ///////////////////////////////////////////////////////////////////////////
    // Fixnum binding

    public static IRubyObject instVarNullToNil(IRubyObject value, IRubyObject nil, String name) {
<span class="nc bnc" id="L720" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L721">            Ruby runtime = nil.getRuntime();</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">            if (runtime.isVerbose()) {</span>
<span class="nc" id="L723">                nil.getRuntime().getWarnings().warning(IRubyWarnings.ID.IVAR_NOT_INITIALIZED, &quot;instance variable &quot; + name + &quot; not initialized&quot;);</span>
            }
<span class="nc" id="L725">            return nil;</span>
        }
<span class="nc" id="L727">        return value;</span>
    }

    public static boolean testArg0ModuleMatch(IRubyObject arg0, int id) {
<span class="nc bnc" id="L731" title="All 4 branches missed.">        return arg0 instanceof RubyModule &amp;&amp; ((RubyModule)arg0).id == id;</span>
    }

    private static String extractSourceInfo(VariableSite site) {
<span class="nc" id="L735">        return &quot; (&quot; + site.file() + &quot;:&quot; + site.line() + &quot;)&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.3.201501050207</span></div></body></html>