<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RubyRational.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rubyspec coverage</a> &gt; <a href="index.source.html" class="el_package">org.jruby</a> &gt; <span class="el_source">RubyRational.java</span></div><h1>RubyRational.java</h1><pre class="source lang-java linenums">/***** BEGIN LICENSE BLOCK *****
 * Version: EPL 1.0/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Eclipse Public
 * License Version 1.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of
 * the License at http://www.eclipse.org/legal/epl-v10.html
 *
 * Software distributed under the License is distributed on an &quot;AS
 * IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or
 * implied. See the License for the specific language governing
 * rights and limitations under the License.
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),
 * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the EPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the EPL, the GPL or the LGPL.
 ***** END LICENSE BLOCK *****/
package org.jruby;

import static org.jruby.util.Numeric.checkInteger;
import static org.jruby.util.Numeric.f_abs;
import static org.jruby.util.Numeric.f_add;
import static org.jruby.util.Numeric.f_cmp;
import static org.jruby.util.Numeric.f_div;
import static org.jruby.util.Numeric.f_equal;
import static org.jruby.util.Numeric.f_expt;
import static org.jruby.util.Numeric.f_floor;
import static org.jruby.util.Numeric.f_gcd;
import static org.jruby.util.Numeric.f_idiv;
import static org.jruby.util.Numeric.f_inspect;
import static org.jruby.util.Numeric.f_integer_p;
import static org.jruby.util.Numeric.f_lt_p;
import static org.jruby.util.Numeric.f_mul;
import static org.jruby.util.Numeric.f_negate;
import static org.jruby.util.Numeric.f_negative_p;
import static org.jruby.util.Numeric.f_one_p;
import static org.jruby.util.Numeric.f_rshift;
import static org.jruby.util.Numeric.f_sub;
import static org.jruby.util.Numeric.f_to_f;
import static org.jruby.util.Numeric.f_to_i;
import static org.jruby.util.Numeric.f_to_r;
import static org.jruby.util.Numeric.f_to_s;
import static org.jruby.util.Numeric.f_truncate;
import static org.jruby.util.Numeric.f_xor;
import static org.jruby.util.Numeric.f_zero_p;
import static org.jruby.util.Numeric.i_gcd;
import static org.jruby.util.Numeric.i_ilog2;
import static org.jruby.util.Numeric.k_exact_p;
import static org.jruby.util.Numeric.ldexp;
import static org.jruby.util.Numeric.nurat_rationalize_internal;

import java.io.IOException;

import org.jcodings.specific.ASCIIEncoding;
import org.jruby.anno.JRubyClass;
import org.jruby.anno.JRubyMethod;
import org.jruby.common.IRubyWarnings;
import org.jruby.runtime.Arity;
import org.jruby.runtime.Block;
import org.jruby.runtime.ClassIndex;
import org.jruby.runtime.ObjectAllocator;
import org.jruby.runtime.ObjectMarshal;
import org.jruby.runtime.ThreadContext;
import org.jruby.runtime.Visibility;
import org.jruby.runtime.builtin.IRubyObject;
import org.jruby.runtime.marshal.MarshalStream;
import org.jruby.runtime.marshal.UnmarshalStream;
import org.jruby.util.ByteList;
import org.jruby.util.Numeric;
import org.jruby.util.TypeConverter;

import static org.jruby.runtime.Helpers.invokedynamic;
import static org.jruby.runtime.invokedynamic.MethodNames.HASH;

/**
 *  1.9 rational.c as of revision: 20011
 */

<span class="pc bpc" id="L87" title="1 of 2 branches missed.">@JRubyClass(name = &quot;Rational&quot;, parent = &quot;Numeric&quot;, include = &quot;Precision&quot;)</span>
public class RubyRational extends RubyNumeric {
    
    public static RubyClass createRationalClass(Ruby runtime) {
<span class="fc" id="L91">        RubyClass rationalc = runtime.defineClass(&quot;Rational&quot;, runtime.getNumeric(), RATIONAL_ALLOCATOR);</span>
<span class="fc" id="L92">        runtime.setRational(rationalc);</span>

<span class="fc" id="L94">        rationalc.setClassIndex(ClassIndex.RATIONAL);</span>
<span class="fc" id="L95">        rationalc.setReifiedClass(RubyRational.class);</span>
        
<span class="fc" id="L97">        rationalc.kindOf = new RubyModule.JavaClassKindOf(RubyRational.class);</span>

<span class="fc" id="L99">        rationalc.setMarshal(RATIONAL_MARSHAL);</span>
<span class="fc" id="L100">        rationalc.defineAnnotatedMethods(RubyRational.class);</span>

<span class="fc" id="L102">        rationalc.getSingletonClass().undefineMethod(&quot;allocate&quot;);</span>
<span class="fc" id="L103">        rationalc.getSingletonClass().undefineMethod(&quot;new&quot;);</span>

<span class="fc" id="L105">        return rationalc;</span>
    }

<span class="fc" id="L108">    private static ObjectAllocator RATIONAL_ALLOCATOR = new ObjectAllocator() {</span>
        @Override
        public IRubyObject allocate(Ruby runtime, RubyClass klass) {
<span class="fc" id="L111">            RubyFixnum zero = RubyFixnum.zero(runtime);</span>
<span class="fc" id="L112">            return new RubyRational(runtime, klass, zero, zero);</span>
        }
    };

    /** internal
     * 
     */
    private RubyRational(Ruby runtime, IRubyObject clazz, IRubyObject num, IRubyObject den) {
<span class="fc" id="L120">        super(runtime, (RubyClass)clazz);</span>
<span class="fc" id="L121">        this.num = num;</span>
<span class="fc" id="L122">        this.den = den;</span>
<span class="fc" id="L123">    }</span>

    /** rb_rational_raw
     * 
     */
    static RubyRational newRationalRaw(Ruby runtime, IRubyObject x, IRubyObject y) {
<span class="fc" id="L129">        return new RubyRational(runtime, runtime.getRational(), x, y);</span>
    }

    /** rb_rational_raw1
     * 
     */
    static RubyRational newRationalRaw(Ruby runtime, IRubyObject x) {
<span class="fc" id="L136">        return new RubyRational(runtime, runtime.getRational(), x, RubyFixnum.one(runtime));</span>
    }

    /** rb_rational_new1
     * 
     */
    static IRubyObject newRationalCanonicalize(ThreadContext context, IRubyObject x) {
<span class="fc" id="L143">        return newRationalCanonicalize(context, x, RubyFixnum.one(context.runtime));</span>
    }

    /** rb_rational_new
     * 
     */
    private static IRubyObject newRationalCanonicalize(ThreadContext context, IRubyObject x, IRubyObject y) {
<span class="fc" id="L150">        return canonicalizeInternal(context, context.runtime.getRational(), x, y);</span>
    }
    
    /** f_rational_new2
     * 
     */
    private static IRubyObject newRational(ThreadContext context, IRubyObject clazz, IRubyObject x, IRubyObject y) {
<span class="pc bpc" id="L157" title="5 of 6 branches missed.">        assert !(x instanceof RubyRational) &amp;&amp; !(y instanceof RubyRational);</span>
<span class="fc" id="L158">        return canonicalizeInternal(context, clazz, x, y);</span>
    }

    /** f_rational_new_no_reduce2
     * 
     */
    private static IRubyObject newRationalNoReduce(ThreadContext context, IRubyObject clazz, IRubyObject x, IRubyObject y) {
<span class="pc bpc" id="L165" title="5 of 6 branches missed.">        assert !(x instanceof RubyRational) &amp;&amp; !(y instanceof RubyRational);</span>
<span class="fc" id="L166">        return canonicalizeInternalNoReduce(context, clazz, x, y);</span>
    }

    /** f_rational_new_bang2
     * 
     */
    private static RubyRational newRationalBang(ThreadContext context, IRubyObject clazz, IRubyObject x, IRubyObject y) { 
<span class="pc bpc" id="L173" title="5 of 6 branches missed.">        assert !f_negative_p(context, y) &amp;&amp; !(f_zero_p(context, y));</span>
<span class="fc" id="L174">        return new RubyRational(context.runtime, clazz, x, y);</span>
    }

    /** f_rational_new_bang1
     * 
     */
    private static RubyRational newRationalBang(ThreadContext context, IRubyObject clazz, IRubyObject x) {
<span class="fc" id="L181">        return newRationalBang(context, clazz, x, RubyFixnum.one(context.runtime));</span>
    }
    
    private IRubyObject num;
    private IRubyObject den;

    /** nurat_canonicalization
     *
     */
<span class="fc" id="L190">    private static boolean canonicalization = false;</span>
    public static void setCanonicalization(boolean canonical) {
<span class="nc" id="L192">        canonicalization = canonical;</span>
<span class="nc" id="L193">    }</span>

    /** nurat_int_check
     * 
     */
    static void intCheck(ThreadContext context, IRubyObject num) {
<span class="fc bfc" id="L199" title="All 4 branches covered.">        if (num instanceof RubyFixnum || num instanceof RubyBignum) return;</span>
<span class="pc bpc" id="L200" title="1 of 4 branches missed.">        if (!(num instanceof RubyNumeric) || !num.callMethod(context, &quot;integer?&quot;).isTrue()) {</span>
<span class="fc" id="L201">            Ruby runtime = num.getRuntime();</span>
<span class="fc" id="L202">            throw runtime.newTypeError(&quot;can't convert &quot;</span>
<span class="fc" id="L203">                    + num.getMetaClass().getName() + &quot; into Rational&quot;);</span>
        }
<span class="nc" id="L205">    }</span>

    /** nurat_int_value
     * 
     */
    static IRubyObject intValue(ThreadContext context, IRubyObject num) {
<span class="fc" id="L211">        intCheck(context, num);</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">        if (!(num instanceof RubyInteger)) num = num.callMethod(context, &quot;to_f&quot;);</span>
<span class="fc" id="L213">        return num;</span>
    }
    
    /** nurat_s_canonicalize_internal
     * 
     */
    private static IRubyObject canonicalizeInternal(ThreadContext context, IRubyObject clazz, IRubyObject num, IRubyObject den) {
<span class="fc" id="L220">        Ruby runtime = context.runtime;</span>
<span class="fc" id="L221">        IRubyObject res = f_cmp(context, den, RubyFixnum.zero(runtime));</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if (res == RubyFixnum.minus_one(runtime)) {</span>
<span class="nc" id="L223">            num = f_negate(context, num);</span>
<span class="nc" id="L224">            den = f_negate(context, den);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">        } else if (res == RubyFixnum.zero(runtime)) {</span>
<span class="fc" id="L226">            throw runtime.newZeroDivisionError();            </span>
        }

<span class="fc" id="L229">        IRubyObject gcd = f_gcd(context, num, den);</span>
<span class="fc" id="L230">        num = f_idiv(context, num, gcd);</span>
<span class="fc" id="L231">        den = f_idiv(context, den, gcd);</span>

<span class="pc bpc" id="L233" title="3 of 4 branches missed.">        if (Numeric.CANON &amp;&amp; canonicalization &amp;&amp; f_one_p(context, den)) {</span>
<span class="nc" id="L234">            return num;</span>
        }

<span class="fc" id="L237">        return new RubyRational(context.runtime, clazz, num, den);</span>
    }
    
    /** nurat_s_canonicalize_internal_no_reduce
     * 
     */
    private static IRubyObject canonicalizeInternalNoReduce(ThreadContext context, IRubyObject clazz, IRubyObject num, IRubyObject den) {
<span class="fc" id="L244">        Ruby runtime = context.runtime;</span>
<span class="fc" id="L245">        IRubyObject res = f_cmp(context, den, RubyFixnum.zero(runtime));</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">        if (res == RubyFixnum.minus_one(runtime)) {</span>
<span class="nc" id="L247">            num = f_negate(context, num);</span>
<span class="nc" id="L248">            den = f_negate(context, den);</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        } else if (res == RubyFixnum.zero(runtime)) {</span>
<span class="nc" id="L250">            throw runtime.newZeroDivisionError();            </span>
        }

<span class="pc bpc" id="L253" title="3 of 4 branches missed.">        if (Numeric.CANON &amp;&amp; canonicalization &amp;&amp; f_one_p(context, den)) {</span>
<span class="nc" id="L254">            return num;</span>
        }

<span class="fc" id="L257">        return new RubyRational(context.runtime, clazz, num, den);</span>
    }
    
    /** nurat_s_new
     * 
     */
    @Deprecated
    public static IRubyObject newInstance(ThreadContext context, IRubyObject clazz, IRubyObject[]args) {
<span class="nc bnc" id="L265" title="All 3 branches missed.">        switch (args.length) {</span>
<span class="nc" id="L266">        case 1: return newInstance(context, clazz, args[0]);</span>
<span class="nc" id="L267">        case 2: return newInstance(context, clazz, args[0], args[1]);</span>
        }
<span class="nc" id="L269">        Arity.raiseArgumentError(context.runtime, args.length, 1, 1);</span>
<span class="nc" id="L270">        return null;</span>
    }

    // @JRubyMethod(name = &quot;new&quot;, meta = true, visibility = Visibility.PRIVATE)
    public static IRubyObject newInstance(ThreadContext context, IRubyObject clazz, IRubyObject num) {
<span class="fc" id="L275">        num = intValue(context, num);</span>
<span class="fc" id="L276">        return canonicalizeInternal(context, clazz, num, RubyFixnum.one(context.runtime));</span>
    }

    // @JRubyMethod(name = &quot;new&quot;, meta = true, visibility = Visibility.PRIVATE)
    public static IRubyObject newInstance(ThreadContext context, IRubyObject clazz, IRubyObject num, IRubyObject den) {
<span class="fc" id="L281">        num = intValue(context, num);</span>
<span class="fc" id="L282">        den = intValue(context, den);</span>
<span class="fc" id="L283">        return canonicalizeInternal(context, clazz, num, den);</span>
    }
    
    /** rb_Rational1
     * 
     */
    public static IRubyObject newRationalConvert(ThreadContext context, IRubyObject x) {
<span class="fc" id="L290">        return newRationalConvert(context, x, RubyFixnum.one(context.runtime));</span>
    }

    /** rb_Rational/rb_Rational2
     * 
     */
    public static IRubyObject newRationalConvert(ThreadContext context, IRubyObject x, IRubyObject y) {
<span class="fc" id="L297">        return convert(context, context.runtime.getRational(), x, y);</span>
    }
    
    public static RubyRational newRational(Ruby runtime, long x, long y) {
<span class="nc" id="L301">        return new RubyRational(runtime, runtime.getRational(), runtime.newFixnum(x), runtime.newFixnum(y));</span>
    }
    
    @Deprecated
    public static IRubyObject convert(ThreadContext context, IRubyObject clazz, IRubyObject[]args) {
<span class="nc bnc" id="L306" title="All 3 branches missed.">        switch (args.length) {</span>
<span class="nc" id="L307">        case 1: return convert(context, clazz, args[0]);        </span>
<span class="nc" id="L308">        case 2: return convert(context, clazz, args[0], args[1]);</span>
        }
<span class="nc" id="L310">        Arity.raiseArgumentError(context.runtime, args.length, 1, 1);</span>
<span class="nc" id="L311">        return null;</span>
    }

    /** nurat_s_convert
     * 
     */
    @JRubyMethod(name = &quot;convert&quot;, meta = true, visibility = Visibility.PRIVATE)
    public static IRubyObject convert(ThreadContext context, IRubyObject recv, IRubyObject a1) {
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (a1.isNil()) {</span>
<span class="fc" id="L320">            throw context.runtime.newTypeError(&quot;can't convert nil into Rational&quot;);</span>
        }

<span class="fc" id="L323">        return convertCommon(context, recv, a1, context.runtime.getNil());</span>
    }

    /** nurat_s_convert
     * 
     */
    @JRubyMethod(name = &quot;convert&quot;, meta = true, visibility = Visibility.PRIVATE)
    public static IRubyObject convert(ThreadContext context, IRubyObject recv, IRubyObject a1, IRubyObject a2) {
<span class="pc bpc" id="L331" title="1 of 4 branches missed.">        if (a1.isNil() || a2.isNil()) {</span>
<span class="fc" id="L332">            throw context.runtime.newTypeError(&quot;can't convert nil into Rational&quot;);</span>
        }
        
<span class="fc" id="L335">        return convertCommon(context, recv, a1, a2);</span>
    }
    
    private static IRubyObject convertCommon(ThreadContext context, IRubyObject recv, IRubyObject a1, IRubyObject a2) {
<span class="fc bfc" id="L339" title="All 2 branches covered.">        if (a1 instanceof RubyComplex) {</span>
<span class="fc" id="L340">            RubyComplex a1Complex = (RubyComplex)a1;</span>
<span class="pc bpc" id="L341" title="1 of 4 branches missed.">            if (k_exact_p(a1Complex.getImage()) &amp;&amp; f_zero_p(context, a1Complex.getImage())) a1 = a1Complex.getReal();            </span>
        }

<span class="pc bpc" id="L344" title="1 of 2 branches missed.">        if (a2 instanceof RubyComplex) {</span>
<span class="nc" id="L345">            RubyComplex a2Complex = (RubyComplex)a2;</span>
<span class="nc bnc" id="L346" title="All 4 branches missed.">            if (k_exact_p(a2Complex.getImage()) &amp;&amp; f_zero_p(context, a2Complex.getImage())) a2 = a2Complex.getReal();</span>
        }
        
<span class="fc bfc" id="L349" title="All 2 branches covered.">        if (a1 instanceof RubyFloat) {</span>
<span class="fc" id="L350">            a1 = f_to_r(context, a1);</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">        } else if (a1 instanceof RubyString) {</span>
<span class="fc" id="L352">            a1 = str_to_r_strict(context, a1);</span>
        } else {
<span class="fc bfc" id="L354" title="All 2 branches covered.">            if (a1.respondsTo(&quot;to_r&quot;)) {</span>
<span class="fc" id="L355">                a1 = f_to_r(context, a1);</span>
            }
        }
        
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">        if (a2 instanceof RubyFloat) {</span>
<span class="nc" id="L360">            a2 = f_to_r(context, a2);</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">        } else if (a2 instanceof RubyString) {</span>
<span class="fc" id="L362">            a2 = str_to_r_strict(context, a2);</span>
        }

<span class="fc bfc" id="L365" title="All 2 branches covered.">        if (a1 instanceof RubyRational) {</span>
<span class="pc bpc" id="L366" title="1 of 6 branches missed.">            if (a2.isNil() || (k_exact_p(a2) &amp;&amp; f_one_p(context, a2))) return a1;</span>
        }

<span class="fc bfc" id="L369" title="All 2 branches covered.">        if (a2.isNil()) {</span>
<span class="pc bpc" id="L370" title="1 of 4 branches missed.">            if (a1 instanceof RubyNumeric &amp;&amp; !f_integer_p(context, a1).isTrue()) return a1;</span>
<span class="fc" id="L371">            return newInstance(context, recv, a1);</span>
        } else {
<span class="pc bpc" id="L373" title="1 of 4 branches missed.">            if (a1 instanceof RubyNumeric &amp;&amp; a2 instanceof RubyNumeric &amp;&amp;</span>
<span class="pc bpc" id="L374" title="1 of 4 branches missed.">                (!f_integer_p(context, a1).isTrue() || !f_integer_p(context, a2).isTrue())) {</span>
<span class="fc" id="L375">                return f_div(context, a1, a2);</span>
            }
<span class="fc" id="L377">            return newInstance(context, recv, a1, a2);</span>
        }
    }

    /** nurat_numerator
     * 
     */
    @JRubyMethod(name = &quot;numerator&quot;)
    @Override
    public IRubyObject numerator(ThreadContext context) {
<span class="fc" id="L387">        return num;</span>
    }

    /** nurat_denominator
     * 
     */
    @JRubyMethod(name = &quot;denominator&quot;)
    @Override
    public IRubyObject denominator(ThreadContext context) {
<span class="fc" id="L396">        return den;</span>
    }

    /** f_imul
     * 
     */
    private static IRubyObject f_imul(ThreadContext context, long a, long b) {
<span class="fc" id="L403">        Ruby runtime = context.runtime;</span>
<span class="fc bfc" id="L404" title="All 4 branches covered.">        if (a == 0 || b == 0) {</span>
<span class="fc" id="L405">            return RubyFixnum.zero(runtime);</span>
<span class="fc bfc" id="L406" title="All 2 branches covered.">        } else if (a == 1) {</span>
<span class="fc" id="L407">            return RubyFixnum.newFixnum(runtime, b);</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">        } else if (b == 1) {</span>
<span class="fc" id="L409">            return RubyFixnum.newFixnum(runtime, a);</span>
        }

<span class="fc" id="L412">        long c = a * b;</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">        if(c / a != b) {</span>
<span class="nc" id="L414">            return RubyBignum.newBignum(runtime, a).op_mul(context, RubyBignum.newBignum(runtime, b));</span>
        }
<span class="fc" id="L416">        return RubyFixnum.newFixnum(runtime, c);</span>
    }
    
    /** f_addsub
     * 
     */
    private IRubyObject f_addsub(ThreadContext context, IRubyObject anum, IRubyObject aden, IRubyObject bnum, IRubyObject bden, boolean plus) {
<span class="fc" id="L423">        Ruby runtime = context.runtime;</span>
        IRubyObject newNum, newDen, g, a, b;
<span class="pc bpc" id="L425" title="4 of 8 branches missed.">        if (anum instanceof RubyFixnum &amp;&amp; aden instanceof RubyFixnum &amp;&amp;</span>
            bnum instanceof RubyFixnum &amp;&amp; bden instanceof RubyFixnum) {
<span class="fc" id="L427">            long an = ((RubyFixnum)anum).getLongValue();</span>
<span class="fc" id="L428">            long ad = ((RubyFixnum)aden).getLongValue();</span>
<span class="fc" id="L429">            long bn = ((RubyFixnum)bnum).getLongValue();</span>
<span class="fc" id="L430">            long bd = ((RubyFixnum)bden).getLongValue();</span>
<span class="fc" id="L431">            long ig = i_gcd(ad, bd);</span>

<span class="fc" id="L433">            g = RubyFixnum.newFixnum(runtime, ig);</span>
<span class="fc" id="L434">            a = f_imul(context, an, bd / ig);</span>
<span class="fc" id="L435">            b = f_imul(context, bn, ad / ig);</span>
<span class="fc" id="L436">        } else {</span>
<span class="nc" id="L437">            g = f_gcd(context, aden, bden);</span>
<span class="nc" id="L438">            a = f_mul(context, anum, f_idiv(context, bden, g));</span>
<span class="nc" id="L439">            b = f_mul(context, bnum, f_idiv(context, aden, g));</span>
        }

<span class="fc bfc" id="L442" title="All 2 branches covered.">        IRubyObject c = plus ? f_add(context, a, b) : f_sub(context, a, b);</span>

<span class="fc" id="L444">        b = f_idiv(context, aden, g);</span>
<span class="fc" id="L445">        g = f_gcd(context, c, g);</span>
<span class="fc" id="L446">        newNum = f_idiv(context, c, g);</span>
<span class="fc" id="L447">        a = f_idiv(context, bden, g);</span>
<span class="fc" id="L448">        newDen = f_mul(context, a, b);</span>
        
<span class="fc" id="L450">        return RubyRational.newRationalNoReduce(context, getMetaClass(), newNum, newDen);</span>
    }
    
    /** nurat_add
     * 
     */
    @JRubyMethod(name = &quot;+&quot;)
    public IRubyObject op_add(ThreadContext context, IRubyObject other) {
<span class="pc bpc" id="L458" title="1 of 4 branches missed.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {</span>
<span class="fc" id="L459">            return f_addsub(context, num, den, other, RubyFixnum.one(context.runtime), true);</span>
<span class="fc bfc" id="L460" title="All 2 branches covered.">        } else if (other instanceof RubyFloat) {</span>
<span class="fc" id="L461">            return f_add(context, f_to_f(context, this), other);</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">        } else if (other instanceof RubyRational) {</span>
<span class="fc" id="L463">            RubyRational otherRational = (RubyRational)other;</span>
<span class="fc" id="L464">            return f_addsub(context, num, den, otherRational.num, otherRational.den, true);</span>
        }            
<span class="fc" id="L466">        return coerceBin(context, &quot;+&quot;, other);</span>
    }
    
    /** nurat_sub
     * 
     */
    @JRubyMethod(name = &quot;-&quot;)
    public IRubyObject op_sub(ThreadContext context, IRubyObject other) {
<span class="pc bpc" id="L474" title="1 of 4 branches missed.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {</span>
<span class="fc" id="L475">            return f_addsub(context, num, den, other, RubyFixnum.one(context.runtime), false);</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">        } else if (other instanceof RubyFloat) {</span>
<span class="fc" id="L477">            return f_sub(context, f_to_f(context, this), other);</span>
<span class="fc bfc" id="L478" title="All 2 branches covered.">        } else if (other instanceof RubyRational) {</span>
<span class="fc" id="L479">            RubyRational otherRational = (RubyRational)other;</span>
<span class="fc" id="L480">            return f_addsub(context, num, den, otherRational.num, otherRational.den, false);</span>
        }
<span class="fc" id="L482">        return coerceBin(context, &quot;-&quot;, other);</span>
    }
    
    /** f_muldiv
     * 
     */
    private IRubyObject f_muldiv(ThreadContext context, IRubyObject anum, IRubyObject aden, IRubyObject bnum, IRubyObject bden, boolean mult) {
<span class="fc bfc" id="L489" title="All 2 branches covered.">        if (!mult) {</span>
<span class="fc bfc" id="L490" title="All 2 branches covered.">            if (f_negative_p(context, bnum)) {</span>
<span class="fc" id="L491">                anum = f_negate(context, anum);</span>
<span class="fc" id="L492">                bnum = f_negate(context, bnum);</span>
            }
<span class="fc" id="L494">            IRubyObject tmp =  bnum;</span>
<span class="fc" id="L495">            bnum = bden;</span>
<span class="fc" id="L496">            bden = tmp;</span>
        }
        
        final IRubyObject newNum, newDen;
<span class="pc bpc" id="L500" title="1 of 8 branches missed.">        if (anum instanceof RubyFixnum &amp;&amp; aden instanceof RubyFixnum &amp;&amp;</span>
            bnum instanceof RubyFixnum &amp;&amp; bden instanceof RubyFixnum) {
<span class="fc" id="L502">            long an = ((RubyFixnum)anum).getLongValue();</span>
<span class="fc" id="L503">            long ad = ((RubyFixnum)aden).getLongValue();</span>
<span class="fc" id="L504">            long bn = ((RubyFixnum)bnum).getLongValue();</span>
<span class="fc" id="L505">            long bd = ((RubyFixnum)bden).getLongValue();</span>
<span class="fc" id="L506">            long g1 = i_gcd(an, bd);</span>
<span class="fc" id="L507">            long g2 = i_gcd(ad, bn);</span>
            
<span class="fc" id="L509">            newNum = f_imul(context, an / g1, bn / g2);</span>
<span class="fc" id="L510">            newDen = f_imul(context, ad / g2, bd / g1);</span>
<span class="fc" id="L511">        } else {</span>
<span class="fc" id="L512">            IRubyObject g1 = f_gcd(context, anum, bden); </span>
<span class="fc" id="L513">            IRubyObject g2 = f_gcd(context, aden, bnum);</span>
            
<span class="fc" id="L515">            newNum = f_mul(context, f_idiv(context, anum, g1), f_idiv(context, bnum, g2));</span>
<span class="fc" id="L516">            newDen = f_mul(context, f_idiv(context, aden, g2), f_idiv(context, bden, g1));</span>
        }

<span class="fc" id="L519">        return RubyRational.newRationalNoReduce(context, getMetaClass(), newNum, newDen);</span>
    }

    /** nurat_mul
     * 
     */
    @JRubyMethod(name = &quot;*&quot;)
    public IRubyObject op_mul(ThreadContext context, IRubyObject other) {
<span class="fc bfc" id="L527" title="All 4 branches covered.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {</span>
<span class="fc" id="L528">            return f_muldiv(context, num, den, other, RubyFixnum.one(context.runtime), true);</span>
<span class="fc bfc" id="L529" title="All 2 branches covered.">        } else if (other instanceof RubyFloat) {</span>
<span class="fc" id="L530">            return f_mul(context, f_to_f(context, this), other);</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">        } else if (other instanceof RubyRational) {</span>
<span class="fc" id="L532">            RubyRational otherRational = (RubyRational)other;</span>
<span class="fc" id="L533">            return f_muldiv(context, num, den, otherRational.num, otherRational.den, true);</span>
        }
<span class="fc" id="L535">        return coerceBin(context, &quot;*&quot;, other);</span>
    }
    
    /** nurat_div
     * 
     */
    @JRubyMethod(name = {&quot;/&quot;, &quot;quo&quot;})
    public IRubyObject op_div(ThreadContext context, IRubyObject other) {
<span class="fc bfc" id="L543" title="All 4 branches covered.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {</span>
<span class="fc bfc" id="L544" title="All 2 branches covered.">            if (f_zero_p(context, other)) {</span>
<span class="fc" id="L545">                throw context.runtime.newZeroDivisionError();</span>
            }
<span class="fc" id="L547">            return f_muldiv(context, num, den, other, RubyFixnum.one(context.runtime), false);</span>
<span class="fc bfc" id="L548" title="All 2 branches covered.">        } else if (other instanceof RubyFloat) {</span>
<span class="fc" id="L549">            return f_to_f(context, this).callMethod(context, &quot;/&quot;, other);</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">        } else if (other instanceof RubyRational) {</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">            if (f_zero_p(context, other)) {</span>
<span class="fc" id="L552">                throw context.runtime.newZeroDivisionError();</span>
            }
<span class="fc" id="L554">            RubyRational otherRational = (RubyRational)other;</span>
<span class="fc" id="L555">            return f_muldiv(context, num, den, otherRational.num, otherRational.den, false);</span>
        }
<span class="fc" id="L557">        return coerceBin(context, &quot;/&quot;, other);</span>
    }

    /** nurat_fdiv
     * 
     */
    @JRubyMethod(name = &quot;fdiv&quot;)
    public IRubyObject op_fdiv(ThreadContext context, IRubyObject other) {
<span class="nc" id="L565">        return f_div(context, f_to_f(context, this), other);</span>
    }

    /** nurat_expt
     * 
     */
    @JRubyMethod(name = &quot;**&quot;)
    public IRubyObject op_expt(ThreadContext context, IRubyObject other) {
<span class="fc" id="L573">        Ruby runtime = context.runtime;</span>

<span class="fc bfc" id="L575" title="All 4 branches covered.">        if (k_exact_p(other) &amp;&amp; f_zero_p(context, other)) {</span>
<span class="fc" id="L576">            return RubyRational.newRationalBang(context, getMetaClass(), RubyFixnum.one(runtime));</span>
        }

<span class="fc bfc" id="L579" title="All 2 branches covered.">        if (other instanceof RubyRational) {</span>
<span class="fc" id="L580">            RubyRational otherRational = (RubyRational)other;</span>
<span class="fc bfc" id="L581" title="All 2 branches covered.">            if (f_one_p(context, otherRational.den)) other = otherRational.num;</span>
        }

<span class="fc bfc" id="L584" title="All 4 branches covered.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {        </span>
            final IRubyObject tnum, tden;
<span class="fc" id="L586">            IRubyObject res = f_cmp(context, other, RubyFixnum.zero(runtime));</span>
<span class="fc bfc" id="L587" title="All 2 branches covered.">            if (res == RubyFixnum.one(runtime)) {</span>
<span class="fc" id="L588">                tnum = f_expt(context, num, other);</span>
<span class="fc" id="L589">                tden = f_expt(context, den, other);</span>
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">            } else if (res == RubyFixnum.minus_one(runtime)){</span>
<span class="fc" id="L591">                tnum = f_expt(context, den, f_negate(context, other));</span>
<span class="fc" id="L592">                tden = f_expt(context, num, f_negate(context, other));</span>
            } else {
<span class="nc" id="L594">                tnum = tden = RubyFixnum.one(runtime);</span>
            }
<span class="fc" id="L596">            return RubyRational.newRational(context, getMetaClass(), tnum, tden);</span>
<span class="fc bfc" id="L597" title="All 4 branches covered.">        } else if (other instanceof RubyFloat || other instanceof RubyRational) {</span>
<span class="fc" id="L598">            return f_expt(context, f_to_f(context, this), other);</span>
        }
<span class="fc" id="L600">        return coerceBin(context, &quot;**&quot;, other);</span>
    }

    
    /** nurat_cmp
     * 
     */
    @JRubyMethod(name = &quot;&lt;=&gt;&quot;)
    @Override
    public IRubyObject op_cmp(ThreadContext context, IRubyObject other) {
<span class="pc bpc" id="L610" title="1 of 4 branches missed.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {</span>
<span class="pc bpc" id="L611" title="1 of 4 branches missed.">            if (den instanceof RubyFixnum &amp;&amp; ((RubyFixnum)den).getLongValue() == 1) return f_cmp(context, num, other);</span>
<span class="fc" id="L612">            return f_cmp(context, this, RubyRational.newRationalBang(context, getMetaClass(), other));</span>
<span class="fc bfc" id="L613" title="All 2 branches covered.">        } else if (other instanceof RubyFloat) {</span>
<span class="fc" id="L614">            return f_cmp(context, f_to_f(context, this), other);</span>
<span class="fc bfc" id="L615" title="All 2 branches covered.">        } else if (other instanceof RubyRational) {</span>
<span class="fc" id="L616">            RubyRational otherRational = (RubyRational)other;</span>
            final IRubyObject num1, num2;
<span class="pc bpc" id="L618" title="4 of 8 branches missed.">            if (num instanceof RubyFixnum &amp;&amp; den instanceof RubyFixnum &amp;&amp;</span>
                otherRational.num instanceof RubyFixnum &amp;&amp; otherRational.den instanceof RubyFixnum) {
<span class="fc" id="L620">                num1 = f_imul(context, ((RubyFixnum)num).getLongValue(), ((RubyFixnum)otherRational.den).getLongValue());</span>
<span class="fc" id="L621">                num2 = f_imul(context, ((RubyFixnum)otherRational.num).getLongValue(), ((RubyFixnum)den).getLongValue());</span>
            } else {
<span class="nc" id="L623">                num1 = f_mul(context, num, otherRational.den);</span>
<span class="nc" id="L624">                num2 = f_mul(context, otherRational.num, den);</span>
            }
<span class="fc" id="L626">            return f_cmp(context, f_sub(context, num1, num2), RubyFixnum.zero(context.runtime));</span>
        }
<span class="fc" id="L628">        return coerceBin(context, &quot;&lt;=&gt;&quot;, other);             </span>
    }

    /** nurat_equal_p
     * 
     */
    @JRubyMethod(name = &quot;==&quot;)
    @Override
    public IRubyObject op_equal(ThreadContext context, IRubyObject other) {
<span class="fc" id="L637">        Ruby runtime = context.runtime;</span>
<span class="pc bpc" id="L638" title="1 of 4 branches missed.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {</span>
<span class="pc bpc" id="L639" title="1 of 4 branches missed.">            if (f_zero_p(context, num) &amp;&amp; f_zero_p(context, other)) return runtime.getTrue();</span>
<span class="pc bpc" id="L640" title="1 of 4 branches missed.">            if (!(den instanceof RubyFixnum) || ((RubyFixnum)den).getLongValue() != 1) return runtime.getFalse();</span>
<span class="fc" id="L641">            return f_equal(context, num, other);</span>
<span class="fc bfc" id="L642" title="All 2 branches covered.">        } else if (other instanceof RubyFloat) {</span>
<span class="fc" id="L643">            return f_equal(context, f_to_f(context, this), other);</span>
<span class="fc bfc" id="L644" title="All 2 branches covered.">        } else if (other instanceof RubyRational) {</span>
<span class="fc" id="L645">            RubyRational otherRational = (RubyRational)other;</span>
<span class="fc bfc" id="L646" title="All 4 branches covered.">            if (f_zero_p(context, num) &amp;&amp; f_zero_p(context, otherRational.num)) return runtime.getTrue();</span>
<span class="fc bfc" id="L647" title="All 2 branches covered.">            return runtime.newBoolean(f_equal(context, num, otherRational.num).isTrue() &amp;&amp;</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">                    f_equal(context, den, otherRational.den).isTrue());</span>

        }
<span class="fc" id="L651">        return f_equal(context, other, this);</span>
    }

    /** nurat_coerce
     * 
     */
    @JRubyMethod(name = &quot;coerce&quot;)
    public IRubyObject op_coerce(ThreadContext context, IRubyObject other) {
<span class="fc" id="L659">        Ruby runtime = context.runtime;</span>
<span class="fc bfc" id="L660" title="All 4 branches covered.">        if (other instanceof RubyFixnum || other instanceof RubyBignum) {</span>
<span class="fc" id="L661">            return runtime.newArray(RubyRational.newRationalBang(context, getMetaClass(), other), this);</span>
<span class="fc bfc" id="L662" title="All 2 branches covered.">        } else if (other instanceof RubyFloat) {</span>
<span class="fc" id="L663">            return runtime.newArray(other, f_to_f(context, this));</span>
<span class="pc bpc" id="L664" title="1 of 2 branches missed.">        } else if (other instanceof RubyRational) {</span>
<span class="fc" id="L665">            return runtime.newArray(other, this);</span>
        }
<span class="nc" id="L667">        throw runtime.newTypeError(other.getMetaClass() + &quot; can't be coerced into &quot; + getMetaClass());</span>
    }

    /** nurat_idiv
     * 
     */
    public IRubyObject op_idiv(ThreadContext context, IRubyObject other) {
<span class="nc" id="L674">        return op_idiv19(context, other);</span>
    }

    @JRubyMethod(name = &quot;div&quot;)
    public IRubyObject op_idiv19(ThreadContext context, IRubyObject other) {
<span class="fc bfc" id="L679" title="All 2 branches covered.">        if (num2dbl(other) == 0.0) throw context.runtime.newZeroDivisionError();</span>

<span class="fc" id="L681">        return f_floor(context, f_div(context, this, other));</span>
    }

    /** nurat_mod
     * 
     */
    public IRubyObject op_mod(ThreadContext context, IRubyObject other) {
<span class="nc" id="L688">        return op_mod19(context, other);</span>
    }

    @JRubyMethod(name = {&quot;modulo&quot;, &quot;%&quot;})
    public IRubyObject op_mod19(ThreadContext context, IRubyObject other) {
<span class="fc bfc" id="L693" title="All 2 branches covered.">        if (num2dbl(other) == 0.0) throw context.runtime.newZeroDivisionError();</span>

<span class="fc" id="L695">        return f_sub(context, this, f_mul(context, other, f_floor(context, f_div(context, this, other))));</span>
    }

    /** nurat_divmod
     * 
     */
    public IRubyObject op_divmod(ThreadContext context, IRubyObject other) {
<span class="nc" id="L702">        return op_divmod19(context, other);</span>
    }

    @JRubyMethod(name = &quot;divmod&quot;)
    public IRubyObject op_divmod19(ThreadContext context, IRubyObject other) {
<span class="fc bfc" id="L707" title="All 2 branches covered.">        if (num2dbl(other) == 0.0) throw context.runtime.newZeroDivisionError();</span>

<span class="fc" id="L709">        IRubyObject val = f_floor(context, f_div(context, this, other));</span>
<span class="fc" id="L710">        return context.runtime.newArray(val, f_sub(context, this, f_mul(context, other, val)));</span>

    }

    /** nurat_rem
     * 
     */
    @JRubyMethod(name = &quot;remainder&quot;)
    public IRubyObject op_rem(ThreadContext context, IRubyObject other) {
<span class="nc" id="L719">        IRubyObject val = f_truncate(context, f_div(context, this, other));</span>
<span class="nc" id="L720">        return f_sub(context, this, f_mul(context, other, val));</span>
    }

    /** nurat_abs
     * 
     */
    @JRubyMethod(name = &quot;abs&quot;)
    public IRubyObject op_abs(ThreadContext context) {
<span class="fc bfc" id="L728" title="All 2 branches covered.">        if (!f_negative_p(context, this)) return this;</span>
<span class="fc" id="L729">        return f_negate(context, this);</span>
    }

    private IRubyObject op_roundCommonPre(ThreadContext context, IRubyObject n) {
<span class="fc" id="L733">        checkInteger(context, n);</span>
<span class="fc" id="L734">        Ruby runtime = context.runtime;</span>
<span class="fc" id="L735">        return f_expt(context, RubyFixnum.newFixnum(runtime, 10), n);</span>
    }

    private IRubyObject op_roundCommonPost(ThreadContext context, IRubyObject s, IRubyObject n, IRubyObject b) {
<span class="fc" id="L739">        s = f_div(context, newRationalBang(context, getMetaClass(), s), b);</span>
<span class="fc bfc" id="L740" title="All 2 branches covered.">        if (f_lt_p(context, n, RubyFixnum.one(context.runtime)).isTrue()) s = f_to_i(context, s);</span>
<span class="fc" id="L741">        return s;</span>
    }

    /** nurat_floor
     * 
     */
    @JRubyMethod(name = &quot;floor&quot;)
    public IRubyObject op_floor(ThreadContext context) {
<span class="fc" id="L749">        return f_idiv(context, num, den);</span>
    }

    @JRubyMethod(name = &quot;floor&quot;)
    public IRubyObject op_floor(ThreadContext context, IRubyObject n) {
<span class="fc" id="L754">        IRubyObject b = op_roundCommonPre(context, n);</span>
<span class="fc" id="L755">        return op_roundCommonPost(context, ((RubyRational)f_mul(context, this, b)).op_floor(context), n, b);</span>
    }

    /** nurat_ceil
     * 
     */
    @JRubyMethod(name = &quot;ceil&quot;)
    public IRubyObject op_ceil(ThreadContext context) {
<span class="fc" id="L763">        return f_negate(context, f_idiv(context, f_negate(context, num), den));</span>
    }

    @JRubyMethod(name = &quot;ceil&quot;)
    public IRubyObject op_ceil(ThreadContext context, IRubyObject n) {
<span class="fc" id="L768">        IRubyObject b = op_roundCommonPre(context, n);</span>
<span class="fc" id="L769">        return op_roundCommonPost(context, ((RubyRational)f_mul(context, this, b)).op_ceil(context), n, b);</span>
    }
    
    @JRubyMethod(name = &quot;to_i&quot;)
    public IRubyObject to_i(ThreadContext context) {
<span class="fc" id="L774">        return op_truncate(context);</span>
    }

    /** nurat_truncate
     * 
     */
    @JRubyMethod(name = &quot;truncate&quot;)
    public IRubyObject op_truncate(ThreadContext context) {
<span class="fc bfc" id="L782" title="All 2 branches covered.">        if (f_negative_p(context, num)) {</span>
<span class="fc" id="L783">            return f_negate(context, f_idiv(context, f_negate(context, num), den));</span>
        }
<span class="fc" id="L785">        return f_idiv(context, num, den);</span>
    }

    @JRubyMethod(name = &quot;truncate&quot;)
    public IRubyObject op_truncate(ThreadContext context, IRubyObject n) {
<span class="fc" id="L790">        IRubyObject b = op_roundCommonPre(context, n);</span>
<span class="fc" id="L791">        return op_roundCommonPost(context, ((RubyRational)f_mul(context, this, b)).op_truncate(context), n, b);</span>
    }

    /** nurat_round
     * 
     */
    @JRubyMethod(name = &quot;round&quot;)
    public IRubyObject op_round(ThreadContext context) {
<span class="fc" id="L799">        IRubyObject myNum = this.num;</span>
<span class="fc" id="L800">        boolean neg = f_negative_p(context, myNum);</span>
<span class="fc bfc" id="L801" title="All 2 branches covered.">        if (neg) myNum = f_negate(context, myNum);</span>

<span class="fc" id="L803">        IRubyObject myDen = this.den;</span>
<span class="fc" id="L804">        IRubyObject two = RubyFixnum.two(context.runtime);</span>
<span class="fc" id="L805">        myNum = f_add(context, f_mul(context, myNum, two), myDen);</span>
<span class="fc" id="L806">        myDen = f_mul(context, myDen, two);</span>
<span class="fc" id="L807">        myNum = f_idiv(context, myNum, myDen);</span>

<span class="fc bfc" id="L809" title="All 2 branches covered.">        if (neg) myNum = f_negate(context, myNum);</span>
<span class="fc" id="L810">        return myNum;</span>
    }

    @JRubyMethod(name = &quot;round&quot;)
    public IRubyObject op_round(ThreadContext context, IRubyObject n) {
<span class="fc" id="L815">        IRubyObject b = op_roundCommonPre(context, n);</span>
<span class="fc" id="L816">        return op_roundCommonPost(context, ((RubyRational)f_mul(context, this, b)).op_round(context), n, b);</span>
    }

    /** nurat_to_f
     * 
     */
<span class="fc" id="L822">    private static long ML = (long)(Math.log(Double.MAX_VALUE) / Math.log(2.0) - 1);</span>
    @JRubyMethod(name = &quot;to_f&quot;)
    public IRubyObject to_f(ThreadContext context) {
<span class="fc" id="L825">        return context.runtime.newFloat(getDoubleValue(context));</span>
    }
    
    @Override
    public double getDoubleValue() {
<span class="fc" id="L830">        return getDoubleValue(getRuntime().getCurrentContext());</span>
    }
    
    public double getDoubleValue(ThreadContext context) {
<span class="fc" id="L834">        Ruby runtime = context.runtime;</span>
<span class="fc bfc" id="L835" title="All 2 branches covered.">        if (f_zero_p(context, num)) return 0;</span>

<span class="fc" id="L837">        IRubyObject myNum = this.num;</span>
<span class="fc" id="L838">        IRubyObject myDen = this.den;</span>

<span class="fc" id="L840">        boolean minus = false;</span>
<span class="fc bfc" id="L841" title="All 2 branches covered.">        if (f_negative_p(context, myNum)) {</span>
<span class="fc" id="L842">            myNum = f_negate(context, myNum);</span>
<span class="fc" id="L843">            minus = true;</span>
        }

<span class="fc" id="L846">        long nl = i_ilog2(context, myNum);</span>
<span class="fc" id="L847">        long dl = i_ilog2(context, myDen);</span>

<span class="fc" id="L849">        long ne = 0;</span>
<span class="pc bpc" id="L850" title="1 of 2 branches missed.">        if (nl &gt; ML) {</span>
<span class="nc" id="L851">            ne = nl - ML;</span>
<span class="nc" id="L852">            myNum = f_rshift(context, myNum, RubyFixnum.newFixnum(runtime, ne));</span>
        }

<span class="fc" id="L855">        long de = 0;</span>
<span class="pc bpc" id="L856" title="1 of 2 branches missed.">        if (dl &gt; ML) {</span>
<span class="nc" id="L857">            de = dl - ML;</span>
<span class="nc" id="L858">            myDen = f_rshift(context, myDen, RubyFixnum.newFixnum(runtime, de));</span>
        }

<span class="fc" id="L861">        long e = ne - de;</span>

<span class="pc bpc" id="L863" title="2 of 4 branches missed.">        if (e &gt; 1023 || e &lt; -1022) {</span>
<span class="nc" id="L864">            runtime.getWarnings().warn(IRubyWarnings.ID.FLOAT_OUT_OF_RANGE, &quot;out of Float range&quot;);</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">            return e &gt; 0 ? Double.MAX_VALUE : 0;</span>
        }

<span class="fc" id="L868">        double f = RubyNumeric.num2dbl(myNum) / RubyNumeric.num2dbl(myDen);</span>

<span class="fc bfc" id="L870" title="All 2 branches covered.">        if (minus) f = -f;</span>

<span class="fc" id="L872">        f = ldexp(f, e);</span>

<span class="pc bpc" id="L874" title="2 of 4 branches missed.">        if (Double.isInfinite(f) || Double.isNaN(f)) {</span>
<span class="nc" id="L875">            runtime.getWarnings().warn(IRubyWarnings.ID.FLOAT_OUT_OF_RANGE, &quot;out of Float range&quot;);</span>
        }

<span class="fc" id="L878">        return f;</span>
    }

    /** nurat_to_r
     * 
     */
    @JRubyMethod(name = &quot;to_r&quot;)
    public IRubyObject to_r(ThreadContext context) {
<span class="fc" id="L886">        return this;</span>
    }

    /** nurat_rationalize
     *
     */
    @JRubyMethod(name = &quot;rationalize&quot;, optional = 1)
    public IRubyObject rationalize(ThreadContext context, IRubyObject[] args) {

        IRubyObject a, b;

<span class="fc bfc" id="L897" title="All 2 branches covered.">        if (args.length == 0) return to_r(context);</span>

<span class="fc bfc" id="L899" title="All 2 branches covered.">        if (f_negative_p(context, this)) {</span>
<span class="fc" id="L900">            return f_negate(context,</span>
<span class="fc" id="L901">                    ((RubyRational) f_abs(context, this)).rationalize(context, args));</span>
        }

<span class="fc" id="L904">        IRubyObject eps = f_abs(context, args[0]);</span>
<span class="fc" id="L905">        a = f_sub(context, this, eps);</span>
<span class="fc" id="L906">        b = f_add(context, this, eps);</span>

<span class="pc bpc" id="L908" title="1 of 2 branches missed.">        if (f_equal(context, a, b).isTrue()) return this;</span>
<span class="fc" id="L909">        IRubyObject[] ary = new IRubyObject[2];</span>
<span class="fc" id="L910">        ary[0] = a;</span>
<span class="fc" id="L911">        ary[1] = b;</span>
<span class="fc" id="L912">        IRubyObject[] ans = nurat_rationalize_internal(context, ary);</span>

<span class="fc" id="L914">        return newRational(context, this.metaClass, ans[0], ans[1]);</span>
    }

    /** nurat_hash
     * 
     */
    @JRubyMethod(name = &quot;hash&quot;)
    public IRubyObject hash(ThreadContext context) {
<span class="fc" id="L922">        return f_xor(context, invokedynamic(context, num, HASH), invokedynamic(context, den, HASH));</span>
    }

    /** nurat_to_s
     * 
     */
    @JRubyMethod(name = &quot;to_s&quot;)
    public IRubyObject to_s(ThreadContext context) {
<span class="fc" id="L930">        RubyString str = RubyString.newEmptyString(context.getRuntime());</span>
<span class="fc" id="L931">        str.append(f_to_s(context, num));</span>
<span class="fc" id="L932">        str.cat((byte)'/');</span>
<span class="fc" id="L933">        str.append(f_to_s(context, den));</span>
<span class="fc" id="L934">        return str;</span>
    }

    /** nurat_inspect
     * 
     */
    @JRubyMethod(name = &quot;inspect&quot;)
    public IRubyObject inspect(ThreadContext context) {
<span class="fc" id="L942">        RubyString str = RubyString.newEmptyString(context.getRuntime());</span>
<span class="fc" id="L943">        str.cat((byte)'(');</span>
<span class="fc" id="L944">        str.append(f_inspect(context, num));</span>
<span class="fc" id="L945">        str.cat((byte)'/');</span>
<span class="fc" id="L946">        str.append(f_inspect(context, den));</span>
<span class="fc" id="L947">        str.cat((byte)')');</span>
<span class="fc" id="L948">        return str;</span>
    }

    /** nurat_marshal_dump
     * 
     */
    @JRubyMethod(name = &quot;marshal_dump&quot;)
    public IRubyObject marshal_dump(ThreadContext context) {
<span class="fc" id="L956">        RubyArray dump = context.runtime.newArray(num, den);</span>
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">        if (hasVariables()) dump.syncVariables(this);</span>
<span class="fc" id="L958">        return dump;</span>
    }

    /** nurat_marshal_load
     * 
     */
    @JRubyMethod(name = &quot;marshal_load&quot;)
    public IRubyObject marshal_load(ThreadContext context, IRubyObject arg) {
<span class="fc" id="L966">        RubyArray load = arg.convertToArray();</span>
<span class="pc bpc" id="L967" title="1 of 2 branches missed.">        num = load.size() &gt; 0 ? load.eltInternal(0) : context.runtime.getNil();</span>
<span class="pc bpc" id="L968" title="1 of 2 branches missed.">        den = load.size() &gt; 1 ? load.eltInternal(1) : context.runtime.getNil();</span>

<span class="pc bpc" id="L970" title="1 of 2 branches missed.">        if (f_zero_p(context, den)) {</span>
<span class="nc" id="L971">            throw context.runtime.newZeroDivisionError();</span>
        }
<span class="pc bpc" id="L973" title="1 of 2 branches missed.">        if (load.hasVariables()) syncVariables((IRubyObject)load);</span>
<span class="fc" id="L974">        return this;</span>
    }

<span class="fc" id="L977">    private static final ObjectMarshal RATIONAL_MARSHAL = new ObjectMarshal() {</span>
        @Override
        public void marshalTo(Ruby runtime, Object obj, RubyClass type,
                              MarshalStream marshalStream) throws IOException {
<span class="nc" id="L981">            throw runtime.newTypeError(&quot;marshal_dump should be used instead for Rational&quot;);</span>
        }

        @Override
        public Object unmarshalFrom(Ruby runtime, RubyClass type,
                                    UnmarshalStream unmarshalStream) throws IOException {
<span class="nc" id="L987">            RubyRational r = (RubyRational) RubyClass.DEFAULT_OBJECT_MARSHAL.unmarshalFrom(runtime, type, unmarshalStream);</span>
<span class="nc" id="L988">            r.num = r.removeInstanceVariable(&quot;@numerator&quot;);</span>
<span class="nc" id="L989">            r.den = r.removeInstanceVariable(&quot;@denominator&quot;);</span>
<span class="nc" id="L990">            return r;</span>
        }
    };

    static RubyArray str_to_r_internal(ThreadContext context, IRubyObject recv) {
<span class="fc" id="L995">        RubyString s = recv.convertToString();</span>
<span class="fc" id="L996">        ByteList bytes = s.getByteList();</span>

<span class="fc" id="L998">        Ruby runtime = context.runtime;</span>
<span class="fc bfc" id="L999" title="All 2 branches covered.">        if (bytes.getRealSize() == 0) return runtime.newArray(runtime.getNil(), recv);</span>

<span class="fc" id="L1001">        IRubyObject m = RubyRegexp.newDummyRegexp(runtime, Numeric.RationalPatterns.rat_pat).match_m19(context, s, false, Block.NULL_BLOCK);</span>
        
<span class="fc bfc" id="L1003" title="All 2 branches covered.">        if (!m.isNil()) {</span>
<span class="fc" id="L1004">            RubyMatchData match = (RubyMatchData)m;</span>
<span class="fc" id="L1005">            IRubyObject si = match.op_aref19(RubyFixnum.one(runtime));</span>
<span class="fc" id="L1006">            RubyString nu = (RubyString)match.op_aref19(RubyFixnum.two(runtime));</span>
<span class="fc" id="L1007">            IRubyObject de = match.op_aref19(RubyFixnum.three(runtime));</span>
<span class="fc" id="L1008">            IRubyObject re = match.post_match(context);</span>
            
<span class="fc" id="L1010">            RubyArray a = nu.split19(context, RubyRegexp.newDummyRegexp(runtime, Numeric.RationalPatterns.an_e_pat), false).convertToArray();</span>
<span class="fc" id="L1011">            RubyString ifp = (RubyString)a.eltInternal(0);</span>
<span class="pc bpc" id="L1012" title="1 of 2 branches missed.">            IRubyObject exp = a.size() != 2 ? runtime.getNil() : a.eltInternal(1);</span>
            
<span class="fc" id="L1014">            a = ifp.split19(context, RubyRegexp.newDummyRegexp(runtime, Numeric.RationalPatterns.a_dot_pat), false).convertToArray();</span>
<span class="fc" id="L1015">            IRubyObject ip = a.eltInternal(0);</span>
<span class="fc bfc" id="L1016" title="All 2 branches covered.">            IRubyObject fp = a.size() != 2 ? runtime.getNil() : a.eltInternal(1);</span>
            
<span class="fc" id="L1018">            IRubyObject v = RubyRational.newRationalCanonicalize(context, f_to_i(context, ip));</span>
            
<span class="fc bfc" id="L1020" title="All 2 branches covered.">            if (!fp.isNil()) {</span>
<span class="fc" id="L1021">                bytes = fp.convertToString().getByteList();</span>
<span class="fc" id="L1022">                int count = 0;</span>
<span class="fc" id="L1023">                byte[]buf = bytes.getUnsafeBytes();</span>
<span class="fc" id="L1024">                int i = bytes.getBegin();</span>
<span class="fc" id="L1025">                int end = i + bytes.getRealSize();</span>

<span class="fc bfc" id="L1027" title="All 2 branches covered.">                while (i &lt; end) {</span>
<span class="pc bpc" id="L1028" title="1 of 2 branches missed.">                    if (ASCIIEncoding.INSTANCE.isDigit(buf[i])) count++;</span>
<span class="fc" id="L1029">                    i++;</span>
                }

<span class="fc" id="L1032">                IRubyObject l = f_expt(context, RubyFixnum.newFixnum(runtime, 10), RubyFixnum.newFixnum(runtime, count));</span>
<span class="fc" id="L1033">                v = f_mul(context, v, l);</span>
<span class="fc" id="L1034">                v = f_add(context, v, f_to_i(context, fp));</span>
<span class="fc" id="L1035">                v = f_div(context, v, l);</span>
            }

<span class="fc bfc" id="L1038" title="All 2 branches covered.">            if (!si.isNil()) {</span>
<span class="fc" id="L1039">                ByteList siBytes = si.convertToString().getByteList();</span>
<span class="pc bpc" id="L1040" title="1 of 4 branches missed.">                if (siBytes.length() &gt; 0 &amp;&amp; siBytes.get(0) == '-') v = f_negate(context, v); </span>
            }

<span class="pc bpc" id="L1043" title="1 of 2 branches missed.">            if (!exp.isNil()) {</span>
<span class="nc" id="L1044">                v = f_mul(context, v, f_expt(context, RubyFixnum.newFixnum(runtime, 10), f_to_i(context, exp)));</span>
            }

<span class="fc bfc" id="L1047" title="All 2 branches covered.">            if (!de.isNil()) {</span>
<span class="fc" id="L1048">                v = f_div(context, v, f_to_i(context, de));</span>
            }
<span class="fc" id="L1050">            return runtime.newArray(v, re);</span>
        }
<span class="fc" id="L1052">        return runtime.newArray(runtime.getNil(), recv);</span>
    }
    
    private static IRubyObject str_to_r_strict(ThreadContext context, IRubyObject recv) {
<span class="fc" id="L1056">        RubyArray a = str_to_r_internal(context, recv);</span>
<span class="pc bpc" id="L1057" title="2 of 4 branches missed.">        if (a.eltInternal(0).isNil() || a.eltInternal(1).convertToString().getByteList().length() &gt; 0) {</span>
<span class="nc" id="L1058">            IRubyObject s = recv.callMethod(context, &quot;inspect&quot;);</span>
<span class="nc" id="L1059">            throw context.runtime.newArgumentError(&quot;invalid value for convert(): &quot; + s.convertToString());</span>
        }
<span class="fc" id="L1061">        return a.eltInternal(0);</span>
    }

    /**
     * numeric_quo
     */
    public static IRubyObject numericQuo(ThreadContext context, IRubyObject x, IRubyObject y) {
<span class="fc bfc" id="L1068" title="All 2 branches covered.">        if (y instanceof RubyFloat) {</span>
<span class="fc" id="L1069">            return ((RubyNumeric)x).fdiv(context, y);</span>
        }

<span class="pc bpc" id="L1072" title="1 of 2 branches missed.">        if (Numeric.CANON &amp;&amp; canonicalization) {</span>
<span class="nc" id="L1073">            x = newRationalRaw(context.runtime, x);</span>
        } else {
<span class="fc" id="L1075">            x = TypeConverter.convertToType(x, context.runtime.getRational(), &quot;to_r&quot;);</span>
        }
<span class="fc" id="L1077">        return x.callMethod(context, &quot;/&quot;, y);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.3.201501050207</span></div></body></html>